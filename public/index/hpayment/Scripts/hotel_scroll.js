/*!art-template - Template Engine | http://aui.github.com/artTemplate/*/
!function(){function a(a){return a.replace(t,"").replace(u,",").replace(v,"").replace(w,"").replace(x,"").split(y)}function b(a){return"'"+a.replace(/('|\\)/g,"\\$1").replace(/\r/g,"\\r").replace(/\n/g,"\\n")+"'"}function c(c,d){function e(a){return m+=a.split(/\n/).length-1,k&&(a=a.replace(/\s+/g," ").replace(/<!--[\w\W]*?-->/g,"")),a&&(a=s[1]+b(a)+s[2]+"\n"),a}function f(b){var c=m;if(j?b=j(b,d):g&&(b=b.replace(/\n/g,function(){return m++,"$line="+m+";"})),0===b.indexOf("=")){var e=l&&!/^=[=#]/.test(b);if(b=b.replace(/^=[=#]?|[\s;]*$/g,""),e){var f=b.replace(/\s*\([^\)]+\)/,"");n[f]||/^(include|print)$/.test(f)||(b="$escape("+b+")")}else b="$string("+b+")";b=s[1]+b+s[2]}return g&&(b="$line="+c+";"+b),r(a(b),function(a){if(a&&!p[a]){var b;b="print"===a?u:"include"===a?v:n[a]?"$utils."+a:o[a]?"$helpers."+a:"$data."+a,w+=a+"="+b+",",p[a]=!0}}),b+"\n"}var g=d.debug,h=d.openTag,i=d.closeTag,j=d.parser,k=d.compress,l=d.escape,m=1,p={$data:1,$filename:1,$utils:1,$helpers:1,$out:1,$line:1},q="".trim,s=q?["$out='';","$out+=",";","$out"]:["$out=[];","$out.push(",");","$out.join('')"],t=q?"$out+=text;return $out;":"$out.push(text);",u="function(){var text=''.concat.apply('',arguments);"+t+"}",v="function(filename,data){data=data||$data;var text=$utils.$include(filename,data,$filename);"+t+"}",w="'use strict';var $utils=this,$helpers=$utils.$helpers,"+(g?"$line=0,":""),x=s[0],y="return new String("+s[3]+");";r(c.split(h),function(a){a=a.split(i);var b=a[0],c=a[1];1===a.length?x+=e(b):(x+=f(b),c&&(x+=e(c)))});var z=w+x+y;g&&(z="try{"+z+"}catch(e){throw {filename:$filename,name:'Render Error',message:e.message,line:$line,source:"+b(c)+".split(/\\n/)[$line-1].replace(/^\\s+/,'')};}");try{var A=new Function("$data","$filename",z);return A.prototype=n,A}catch(B){throw B.temp="function anonymous($data,$filename) {"+z+"}",B}}var d=function(a,b){return"string"==typeof b?q(b,{filename:a}):g(a,b)};d.version="3.0.0",d.config=function(a,b){e[a]=b};var e=d.defaults={openTag:"<%",closeTag:"%>",escape:!0,cache:!0,compress:!1,parser:null},f=d.cache={};d.render=function(a,b){return q(a,b)};var g=d.renderFile=function(a,b){var c=d.get(a)||p({filename:a,name:"Render Error",message:"Template not found"});return b?c(b):c};d.get=function(a){var b;if(f[a])b=f[a];else if("object"==typeof document){var c=document.getElementById(a);if(c){var d=(c.value||c.innerHTML).replace(/^\s*|\s*$/g,"");b=q(d,{filename:a})}}return b};var h=function(a,b){return"string"!=typeof a&&(b=typeof a,"number"===b?a+="":a="function"===b?h(a.call(a)):""),a},i={"<":"&#60;",">":"&#62;",'"':"&#34;","'":"&#39;","&":"&#38;"},j=function(a){return i[a]},k=function(a){return h(a).replace(/&(?![\w#]+;)|[<>"']/g,j)},l=Array.isArray||function(a){return"[object Array]"==={}.toString.call(a)},m=function(a,b){var c,d;if(l(a))for(c=0,d=a.length;d>c;c++)b.call(a,a[c],c,a);else for(c in a)b.call(a,a[c],c)},n=d.utils={$helpers:{},$include:g,$string:h,$escape:k,$each:m};d.helper=function(a,b){o[a]=b};var o=d.helpers=n.$helpers;d.onerror=function(a){var b="Template Error\n\n";for(var c in a)b+="<"+c+">\n"+a[c]+"\n\n";"object"==typeof console&&console.error(b)};var p=function(a){return d.onerror(a),function(){return"{Template Error}"}},q=d.compile=function(a,b){function d(c){try{return new i(c,h)+""}catch(d){return b.debug?p(d)():(b.debug=!0,q(a,b)(c))}}b=b||{};for(var g in e)void 0===b[g]&&(b[g]=e[g]);var h=b.filename;try{var i=c(a,b)}catch(j){return j.filename=h||"anonymous",j.name="Syntax Error",p(j)}return d.prototype=i.prototype,d.toString=function(){return i.toString()},h&&b.cache&&(f[h]=d),d},r=n.$each,s="break,case,catch,continue,debugger,default,delete,do,else,false,finally,for,function,if,in,instanceof,new,null,return,switch,this,throw,true,try,typeof,var,void,while,with,abstract,boolean,byte,char,class,const,double,enum,export,extends,final,float,goto,implements,import,int,interface,long,native,package,private,protected,public,short,static,super,synchronized,throws,transient,volatile,arguments,let,yield,undefined",t=/\/\*[\w\W]*?\*\/|\/\/[^\n]*\n|\/\/[^\n]*$|"(?:[^"\\]|\\[\w\W])*"|'(?:[^'\\]|\\[\w\W])*'|\s*\.\s*[$\w\.]+/g,u=/[^\w$]+/g,v=new RegExp(["\\b"+s.replace(/,/g,"\\b|\\b")+"\\b"].join("|"),"g"),w=/^\d[^,]*|,\d[^,]*/g,x=/^,+|,+$/g,y=/^$|,+/;"function"==typeof define?define(function(){return d}):"undefined"!=typeof exports?module.exports=d:this.template=d}();;$(function(){hotel_check.check_rz_name(1);hotel_check.check_rz_nation(1);hotel_check.check_all_tel(1);hotel_check.submitCheckAllImfor();hotel_check.check_agreement(1);hotel_check.check_email(1);hotel_check.check_terms_accept();hotel_check.noRoomPaid();})
var isAllImforRight=0;var oldName="";var hotel_check={changeHouse:function(){$("#houseNum").change(function(){var num=$('#houseNum option:selected').text();var rz_people=$("#rz_people").find("input").length;var rz_nation=$("#rz_nation").find("input").length;hotel_check.init_rz_num(rz_people,num);hotel_check.init_rz_nation(rz_nation,num);var $single_price=$('#single_total_price').val();var $total_price=num*$single_price;$total_price=parseFloat($total_price).toFixed(2);$('.order_table .hotel_price').text('¥'+$total_price);$('#total_price').val($total_price);})},init_rz_num:function(v,t){if($('ul#rz_people').length){hotel_check.init_rz_ga_name(v,t);return false;}
if(t>v){for(var j=v;j<t;j++){var str="<input id='rz_name_"+j+"' class='input_txt grey' type='text' name='tourist[]' value='请填写入住人姓名' />";$("#rz_people").append(str);hotel_check.check_rz_name(1);hotelCommon.txt_focus();}}else{t=(t==0)?1:t;for(var j=t;j<v;j++){$("#rz_name_"+j).remove();}}},init_rz_ga_name:function(v,t){if(t>v){for(var j=v;j<t;j++){var str='<li>'+'<input type="text" value="" class="input_txt grey" name="lastname[]" id="" placeholder="姓(英文/拼音),如:ZHANG" />'+'<input type="text" value="" class="input_txt grey" name="firstname[]" id="" placeholder="名(英文/拼音),如:SAN" />'+'</li>';$("#rz_people").append(str);hotel_check.check_rz_name(1);hotelCommon.txt_focus();}}else{t=(t==0)?1:t;for(var j=v;j>t;j--){$("ul#rz_people li").eq(j-1).remove();}}},init_rz_nation:function(v,t){if(t>v){for(var j=v;j<t;j++){var str="<input id='rz_nation_"+j+"' class='input_txt grey' type='text' name='nation[]' value='请填写入住人国籍' />";$("#rz_nation").append(str);hotel_check.check_rz_nation(1);hotelCommon.txt_focus();}}else{t=(t==0)?1:t;for(var j=t;j<v;j++){$("#rz_nation_"+j).remove();}}},check_name:function(This,errTips){var orignname=$(This).val();var name=$.trim(orignname);$(This).val(name);if($('ul#rz_people li').length){var result=$.TN_checkEnglishName(name);}
else{var result=$.TN_checkName(name);}
var tip=errTips;var str=name.substr(name.length-2);if(name=='请填写入住人姓名'||name=='请填写联系人姓名'||str=='先生'||str=='小姐'||str=='女士'||str=='测试'){this.showErr($(This),$(tip),'请正确填写入住人的真实姓名，以确保顺利入住。');success=0;return false;}
if($('ul#rz_people li').length){hotel_check.checkCommContGa(This);}
else{hotel_check.checkCommCont(name);}
switch(result){case 1:this.hideErr($(This),$(tip));return true;break;case 2:var msg='请正确填写入住人的真实姓名，以确保顺利入住。';this.showErr($(This),$(tip),msg);success=0;return false;break;case 3:$(This).addClass("err");var msg='姓名长度请在4-20字符内（1个汉字等于2个字符）';this.showErr($(This),$(tip),msg);success=0;return false;break;default:var msg='姓名只能包含中文、英文+空格、拼音+空格';if(!$('#rz_name_0').length){msg='姓名只能包含英文';}
this.showErr($(This),$(tip),msg);success=0;return false;break;}},check_nation:function(This,errTips){var nation=$(This).val();var tip=errTips;$(tip).html('');if(nation=='请填写入住人国籍'||nation==''){var msg='请填写入住人的国籍';this.showErr($(This),$(tip),msg);success=0;return false;}else{this.hideErr($(This),$(tip));return true;}},check_tel:function(This,errTips){This=$(This);tip=$(errTips);var tel=This.val();var result=$.TN_checkTel(tel);switch(result){case 1:this.hideErr($(This),$(tip));if($('#user_islogin').val()=='0'&&This.attr('name')=='contact_tel'){orderLogin.check_login_tel(null,null,null,tel);}
return true;break;case 2:this.showErr($(This),$(tip),'请填写正确的手机号码，以便及时与您确认酒店信息。');return false;break;default:this.showErr($(This),$(tip),'请填写正确的手机号码，以便及时与您确认酒店信息。');return false;break;}},check_rz_name:function(t){var rzPeople=$("#rz_people");var rzNameTip="#rz_name_tip";rzPeople.find("input").each(function(i,n){if($(n)){if(t){$(n).focus(function(){$(n).removeClass('grey');hotel_check.set_old_name(n);if($('#user_islogin').val()=='0'){$('#login_tip').css("display","block");if($("#mainland").val()>0){var marginleft=185;var top_orign=30;var top_inc=34;}else{var marginleft=110;var top_orign=30;var top_inc=39;}
if(i%2!==0){$('#login_tip').css("margin-left",marginleft+'px');var margintop=top_orign+((i-1)/2)*top_inc;$('#login_tip').css("margin-top",margintop+"px");}else{$('#login_tip').css("margin-left","0px");var margintop=top_orign+(i/2)*top_inc;$('#login_tip').css("margin-top",margintop+"px");}}else{$('#login_tip').css("display","none");}});$(n).blur(function(){hotel_check.check_name(n,rzNameTip);});}else{hotel_check.check_name(n,rzNameTip);hotel_check.resetIsAllImforRight($(rzNameTip));}}});},init_favors:function(){},set_old_name:function(n){oldName=$(n).val();},check_rz_nation:function(t){var rzNation=$("#rz_nation");var rzNationTip=$("#rz_nation_tip");if($('#needNationality').data('need')){rzNation.find("input").each(function(i,n){if($(n)){if(t){$(n).blur(function(){hotel_check.check_nation(n,rzNationTip);});}else{hotel_check.check_nation(n,rzNationTip);hotel_check.resetIsAllImforRight($(rzNationTip));}}});}},check_book_name:function(t){var book_name="#tourist_name";var book_name_tip="#tourist_name_tip";if($(book_name)){if(t){$(book_name).blur(function(){hotel_check.check_name(book_name,book_name_tip);});}
else{hotel_check.check_name(book_name,book_name_tip);hotel_check.resetIsAllImforRight($(book_name_tip));}}},check_all_tel:function(t){var book_tel="#tourist_tel";var book_tel_tip="#tourist_tel_tip";if(t){$(book_tel).blur(function(){$('#old_login_t').hide();$('#new_login_t').hide();hotel_check.check_tel(book_tel,book_tel_tip);});}
else{hotel_check.check_tel(book_tel,book_tel_tip);hotel_check.resetIsAllImforRight($(book_tel_tip));}},check_agreement:function(t){var reg_agreement="#new_login";$(reg_agreement).click(function(){if($(reg_agreement).is(':checked')){$("#reg_agreement_tip").hide();}else{$("#reg_agreement_tip").show().text('请阅读并勾选用户协议');}});if(!t&&$(reg_agreement).is(':visible')&&!$(reg_agreement).is(':checked')){$("#reg_agreement_tip").show().text('请阅读并勾选用户协议');isAllImforRight++;}},check_old_login:function(){var old_login_val=$("#old_login_t").css("display");if($("#old_login_t").length>0){if(old_login_val=='none'||old_login_val=='none;'){}else{$("#old_login_tip").show().text('请先登录');return false;}}
return true;},check_email:function(t){var $email=$("#tourist_email");var pattern=/(?=^.{5,255}$)(^([\w\!\#\$\%\&\'\*\+\-\.\/\?\^\_\`\{\|\}\~]+)@([a-zA-Z0-9\-]+\.)+([a-zA-Z0-9\-]+)$)/;if(t){$email.blur(function(){if($email.val()==''||pattern.test($email.val())==true){$('#tourist_email_tip').hide().find('.msg').html("");}
else{$('#tourist_email_tip').show().find('.msg').text('您输入的邮箱格式不对，格式如：XXXX@XXXX.com。');}});}
else{if($email.val()!=''&&pattern.test($email.val())==false){$('#tourist_email_tip').show().find('.msg').text('您输入的邮箱格式不对，格式如：XXXX@XXXX.com。');isAllImforRight++;}}},check_date_region:function(){var newDate=new Date();var newDateStr=GetDateStr(newDate);var $checkindate=$('#begin_date').val();var $checkoutdate=$('#end_date').val();var $checkoutdateDom=$('#end_date');if(dateDiff('D',newDateStr,$checkoutdate)>271){$('#com_bug').remove();$checkoutdateDom.addClass("err");var _left=$checkoutdateDom.offset().left+165;var _top=$checkoutdateDom.offset().top;var com_bug=$('<div id="com_bug" class="com_bug"><div class="w">如果您需预订'+$checkoutdate+'的酒店，请致电：4007-999-999，我们会竭诚为您服务。</div></div>');com_bug.appendTo("body");com_bug.css({top:_top,left:_left});com_bug.click(function(e){stopPropagation(e);});isAllImforRight++;}
else if(dateDiff('D',$checkindate,$checkoutdate)>28){$('#com_bug').remove();$checkoutdateDom.addClass("err");var _left=$checkoutdateDom.offset().left+165;var _top=$checkoutdateDom.offset().top;var com_bug=$('<div id="com_bug" class="com_bug"><div class="w">您入住的酒店时间超过28天，请分订单提交预订!</div></div>')
com_bug.appendTo("body");com_bug.css({top:_top,left:_left});com_bug.click(function(e){stopPropagation(e);});isAllImforRight++;}},check_terms_accept:function(){if($('#accept').is(':checked')){$('#terms').hide();$('#noRoomPaidContent').hide();$('#acceptError').hide();}else{$('#noRoomPaidContent').hide();$('#acceptError').show();isAllImforRight++;}
$('#accept').off().bind('click',arguments.callee);},noRoomPaid:function(){$('#noRoomPaid a').click(function(){var noRc=$('#noRoomPaidContent');if(noRc.is(':hidden')){$('#terms').hide();noRc.show();$(this).html('收起详情>>');return;}
$('#terms').hide();noRc.hide();$(this).html('查看详情>>');})},init_person_num:function(){var houseNum=$("#houseNum");var houseNumSel=houseNum.find("option:selected").text();var rz_people=$("#rz_people").find("input").length;if(houseNumSel!=rz_people){hotel_check.init_rz_num(rz_people,houseNumSel);}},init_nation_num:function(){var houseNum=$("#houseNum");var houseNumSel=houseNum.find("option:selected").text();var rz_nation=$("#rz_nation").find("input").length;if(houseNumSel!=rz_nation){hotel_check.init_rz_nation(rz_nation,houseNumSel);}},resetIsAllImforRight:function(t){if(t&&t.css("display")!="none"){isAllImforRight++;}},submitCheckAllImfor:function(){var g_next=$("#g_next");g_next.click(function(){if(!hotel_order.checkName()){$("#rz_name_tip .msg").text('请填写不同的入住人姓名，以确保顺利入住');$("#rz_name_tip").show();var top=$("#rz_people").offset().top;$(window).scrollTop(top);return false;}
$('#g_next').attr('disabled',true);isAllImforRight=0;if(!$('#accept')[0].checked){$('#acceptError').show();}else{$('#acceptError').hide();}
hotel_check.check_date_region();hotel_check.check_rz_name(0);hotel_check.check_rz_nation(0);hotel_check.check_all_tel(0);hotel_check.check_agreement(0);hotel_check.check_email(0);hotel_check.check_terms_accept();if(hotel_order.checkDateNum()&&hotel_order.check_invoice_info()&&!isAllImforRight&&hotel_check.check_old_login()){$('#g_next').attr('disabled',false);submitOrder();}else{$('#g_next').attr('disabled',false);return false;}});},scrollToErr:function(t){if(t){var t_top=t.offset().top;$(window).scrollTop(t_top);}},showErr:function(formEle,tip,errMsg){formEle.addClass('err');tip.find('.msg').html(errMsg);tip.show();},hideErr:function(formEle,tip){formEle.removeClass("err");tip.hide().find('.msg').html('');},checkCommContGa:function(This){var ns=$(This).next();if($(ns).val()!==undefined){var old=oldName+" "+$(ns).val();var now=$(This).val()+" "+$(ns).val();}
var ps=$(This).prev();if($(ps).val()!==undefined){var old=$(ps).val()+" "+oldName;var now=$(ps).val()+" "+$(This).val();}
var hotel_favors=$(".hotel_favors");hotel_favors.find("a").each(function(i,n){if($(n)){var $icon=$(n).children();var comm_name=$(n).find("span").html();if(comm_name==old&&$icon.hasClass('selected')){$icon.toggleClass('selected');}
if(comm_name==now&&!$icon.hasClass('selected')){$icon.toggleClass('selected');}}});},checkCommCont:function(name){var hotel_favors=$(".hotel_favors");hotel_favors.find("a").each(function(i,n){if($(n)){var $icon=$(n).children();var comm_name=$(n).find("span").html();if(comm_name==oldName&&$icon.hasClass('selected')){$icon.toggleClass('selected');}
if(comm_name==name&&!$icon.hasClass('selected')){$icon.toggleClass('selected');}}});}}
function RndNum(n){var rnd="";for(var i=0;i<n;i++){rnd+=Math.floor(Math.random()*10);}
return rnd;}
function submitOrder(){$('#g_next').hide();$('.loading').show();$('#dyPop').nodelpop();if(!$('#needNationality').data('need')){$("input[name='nation[]']").attr("value","");}
var sData=$('#form').serialize();var promotionContain=$('#cashbackInfo .discount-coupon .coupon-list .box-selected');if(promotionContain.length){var sId='';promotionContain.each(function(index,element){if(index==0){sId=$(element).data('id')+'-'+$(element).data('type');}else{sId=sId+'|'+$(element).data('id')+'-'+$(element).data('type');}});sData+='&promotionId='+sId;}
$.ajax({url:'/order/subscribe',type:'post',dataType:'json',data:sData,success:function(s){if(s&&s.success){var __zp_tag_params={pagetype:"ordersuceess",p_zp_conversion:"e5c78d8903dfcd8981312949a3b8b042",p_zp_convinfo:"%%hotelid:"+$('#hotel_resource_id').val()+",roomid:"+$('#room_resource_id').val()+"%%,%%orderid:0%%"};(function(param){var c={query:[],args:param||{}};c.query.push(["_setAccount","352"]);(window.__zpSMConfig=window.__zpSMConfig||[]).push(c);var zp=document.createElement("script");zp.type="text/javascript";zp.async=true;zp.src=("https:"==document.location.protocol?"https:":"http:")+"//cdn.zampda.net/s.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(zp,s);})(window.__zp_tag_params);try{_fxcmd.push(['trackOrder',{oid:RndNum(11),otp:RndNum(4)},[]]);}catch(e){}
if(s.isOnline==1){window.location.href='/main.php?do=order_online_cashier&order_id='+s.data.orderId;return false;}
if(s.isGuarantee==1){window.location.href='/order/guarantee/'+s.data.orderId;return false;}
window.location.href='/order/success/'+s.data.orderId;return;}else if(s&&s.errorCode=='972101'){alert('您今天已经提交过相同入住姓名的订单。\n如果您是为朋友预订，请修改实际入住人的姓名。');}else if(s&&(s.errorCode=='130500'||s.errorCode=='139999')){alert(s.msg);}else{window.location.href='/order/error';console.log("%c 下单失败 %c 此处有坑","color:red","","color:orange;font-weight:bold",s);}
$('#g_next').show().attr('disabled',false);$('.loading').hide();$('.divmask').remove();$('#divmask').remove();$('#dyPop').hide();return;},error:function(e){alert('系统正忙，请稍候重试。');}});};$(function(){$('#begin_date, #end_date').TN_date();hotelCommon.txt_focus();hotelCommon.reviseDate();showBookingTips();$('#end_date').focus(function(){$("#com_bug").remove();$('#end_date').removeClass("err");});$('.input_txt').live('blur',hotelCommon.autoComplete);$('body').append($('<input />').attr('type','hidden').attr('id','tourist_name').val($('#rz_name_0').attr('val')));var sI=null;if(sI){clearInterval(sI);}else{sI=setInterval(function(){if($('#tourist_name').val()&&$('#tourist_name').val()!==$('#rz_name_0').val()){var cookieStr=$.trim(readCookie('_tuniu_hotel_book_info_'+$('#mainland').val()));var cookie;try{cookie=jQuery.parseJSON(cookieStr);}catch(e){}
if(!cookie||!cookie.tourist[0]||(cookie.tourist[0]&&cookie.tourist[0]=='')){$('#tourist_name').val()&&$('#rz_name_0').val($('#tourist_name').val());$('#tourist_tel').attr('val')&&$('#tourist_tel').val($('#tourist_tel').attr('val'));clearInterval(sI);}}},500);}});var hotelCommon={changeDate:function(){var begin_date=this.dateTransform($("#begin_date").val());var end_date=this.dateTransform($("#end_date").val());},dateTransform:function(data){if(data=='yyyy-mm-dd'){return'';}
var data_arr=data.split('-');var year=parseInt(data_arr[0]);var month=parseInt(data_arr[1]);var day=parseInt(data_arr[2]);month=month<10?'0'+month:month;day=day<10?'0'+day:day;return year+'-'+month+'-'+day;},txt_focus:function(){$(".input_txt").each(function(i){$(".input_txt").eq(i).focus(function(){var input_val=$(this).val();if(input_val==this.defaultValue){$(this).val('');$(this).removeClass('grey');}});$(".input_txt").eq(i).blur(function(){var input_val=$(this).val();if(input_val==''){$(this).addClass('grey');$(this).val(this.defaultValue);}});})},reviseDate:function(){var inputParent=$("#dateRegion");var inputArr=$("#dateRegion input");var inputDate=inputParent.find(".input_date");var inputBtn=inputParent.find(".changeDate");inputDate.focus(function(){inputDate.addClass("dateTxt");inputBtn.attr("value","确认修改");})
inputBtn.click(function(event){var _val=inputBtn.val();inputDate.toggleClass("dateTxt");if(_val=="修改日期"){$(this).attr("value","确认修改");}
else{$(this).attr("value","修改日期");changeBookDate();}})},autoComplete:function(load){load=load===1?1:0;var cookie_name='_tuniu_hotel_book_info_'+$('#mainland').val();var cookiesStr=$.trim(readCookie(cookie_name));var rz_people_input=$('#rz_people input');var rz_nation_input=$('#rz_nation input');var cookies;try{cookies=jQuery.parseJSON(cookiesStr);}catch(e){}
if(!cookies){cookies={};cookies.houseNum=$('#houseNum').val();cookies.tourist=[];cookies.nation=[];cookies.tel=$('#tourist_tel').val();cookies.email=$('#tourist_email').val();cookies.fapiao={};}else{if(load){if($('#houseNum').val()===$('#houseNum')[0].defaultValue){cookies.houseNum&&$('#houseNum').val(cookies.houseNum);}
cookies.tourist&&rz_people_input.each(function(i){if(rz_people_input.eq(i).val()===rz_people_input.eq(i)[0].defaultValue){if(cookies.tourist[i]){rz_people_input.eq(i).val(cookies.tourist[i]);rz_people_input.eq(i).removeClass('grey');}}
var j=i;if(!$('#rz_name_0').length){j=i/2;}
if(rz_nation_input.length&&rz_nation_input.eq(j).val()===rz_nation_input.eq(j)[0].defaultValue){cookies.nation[j]&&rz_nation_input.eq(j).val(cookies.nation[j]);}});if($('#tourist_tel').val()===$('#tourist_tel')[0].defaultValue){cookies.tel&&$('#tourist_tel').val(cookies.tel);if($('#tourist_tel').val()!=$('#tourist_tel')[0].defaultValue){$('#tourist_tel').removeClass("grey");}}
if($('#tourist_email').val()===$('#tourist_email')[0].defaultValue){cookies.email&&$('#tourist_email').val(cookies.email);}
if(cookies.fapiao){cookies.fapiao.check_fapiao&&$('input:radio[name=check_fapiao][value='+cookies.fapiao.check_fapiao+']').attr('selected',true).trigger('click');if(cookies.fapiao.check_fapiao==='yes'){cookies.fapiao.invoiceType&&$('select[name=invoiceType] option[value='+cookies.fapiao.invoiceType+']').attr('selected',true).trigger('change');cookies.fapiao.invoice_title&&$('#invoice_title').val(cookies.fapiao.invoice_title);cookies.fapiao.province&&$('#province option[value='+cookies.fapiao.province+']').attr('selected',true).trigger('change');cookies.fapiao.city&&$('#city option[value='+cookies.fapiao.city+']').attr('selected',true).trigger('change');cookies.fapiao.area&&$('#area option[value='+cookies.fapiao.area+']').attr('selected',true).trigger('change');cookies.fapiao.invoice_address&&$('#invoice_address').val(cookies.fapiao.invoice_address);cookies.fapiao.invoice_receiver&&$('#invoice_receiver').val(cookies.fapiao.invoice_receiver);cookies.fapiao.invoice_tel&&$('#invoice_tel').val(cookies.fapiao.invoice_tel);cookies.fapiao.invoice_code&&$('#invoice_code').val(cookies.fapiao.invoice_code);}}}else{if(cookies.houseNum!==$('#houseNum').val()){cookies.houseNum=$('#houseNum').val();}
if(rz_people_input.length>0){rz_people_input.each(function(i){if(!rz_people_input.eq(i).val()||rz_people_input.eq(i).val()===rz_people_input.eq(i)[0].defaultValue){return true;}else{if(cookies.tourist[i]){if(cookies.tourist[i]!==rz_people_input.eq(i).val()){cookies.tourist[i]=rz_people_input.eq(i).val();}
var j=i;if(!$('#rz_name_0').length){j=i/2;}
if(rz_nation_input.length&&rz_nation_input.eq(j).val()&&rz_nation_input.eq(j).val()!==rz_nation_input.eq(j)[0].defaultValue&&cookies.nation[j]!==rz_nation_input.eq(j).val()){cookies.nation[j]=rz_nation_input.eq(j).val();}}else{cookies.tourist.push(rz_people_input.eq(i).val());if(rz_nation_input.length&&rz_nation_input.eq(j).val()&&rz_nation_input.eq(j).val()!==rz_nation_input.eq(j)[0].defaultValue){cookies.nation.push(rz_nation_input.eq(j).val());}}}});}
if(cookies.tel!==$('#tourist_tel').val()){cookies.tel=$('#tourist_tel').val();}
if(cookies.email!==$('#tourist_email').val()){cookies.email=$('#tourist_email').val();}
cookies.fapiao.check_fapiao=$('input:radio[name="check_fapiao"]:checked').val();cookies.fapiao.invoiceType=$('select[name=invoiceType]').val();cookies.fapiao.invoice_title=$('#invoice_title').val();cookies.fapiao.province=$('#province').val();cookies.fapiao.city=$('#city').val();cookies.fapiao.area=$('#area').val();cookies.fapiao.invoice_address=$('#invoice_address').val();cookies.fapiao.invoice_receiver=$('#invoice_receiver').val();cookies.fapiao.invoice_tel=$('#invoice_tel').val();cookies.fapiao.invoice_code=$('#invoice_code').val();}}
createCookie(cookie_name,SerializeJsonToStr(cookies));},reload:function(){var $checkindate=$('#begin_date').val();var $checkoutdate=$('#end_date').val();var roomNum=$('#houseNum').val();var reachTime=$('#hotel_base_info .reachTime').val();var $url='/order/order/'+'?hotel='+$('#hotel_resource_id').val()+'&room='+$('#room_resource_id').val()+'&checkindate='+$checkindate+'&checkoutdate='+$checkoutdate+
(roomNum>0?'&roomNum='+roomNum:'')+
(reachTime?'&reachTime='+reachTime:'')+'&price='+$('#oldprice').val();window.location.href=$url;}}
function SerializeJsonToStr(oJson){if(oJson==null)
return"null";if(typeof(oJson)==typeof(0)){return oJson.toString();}
if(typeof(oJson)==typeof('')||oJson instanceof String){oJson=oJson.toString();oJson=oJson.replace(/\r\n/,'\\r\\n');oJson=oJson.replace(/\n/,'\\n');oJson=oJson.replace(/"/,'\\"');return'"'+oJson+'"';}
if(oJson instanceof Array){var strRet="[";for(var i=0;i<oJson.length;i++){if(strRet.length>1)
strRet+=",";strRet+=SerializeJsonToStr(oJson[i]);}
strRet+="]";return strRet;}
if(typeof(oJson)==typeof({})){var strRet="{";for(var p in oJson){if(strRet.length>1){strRet+=",";}
strRet+='"'+p.toString()+'":'+SerializeJsonToStr(oJson[p]);}
strRet+="}";return strRet;}}
function changeBookDate(){var newDate=new Date();var newDateStr=GetDateStr(newDate);var $checkindate=$('#begin_date').val();var $checkoutdate=$('#end_date').val();var $checkoutdateDom=$('#end_date');if($checkindate==$('#checkin_date').val()&&$checkoutdate==$('#checkout_date').val()){$('#com_bug').remove();return false;}
if(dateDiff('D',newDateStr,$checkindate)>270){$('#com_bug').remove();$checkoutdateDom.addClass("err");var _left=$checkoutdateDom.offset().left+138;var _top=$checkoutdateDom.offset().top;var com_bug=$('<div id="com_bug" class="com_bug"><span class="shdaw"></span><div class="w">如果您需预订'+$checkoutdate+'的酒店，请致电：'+$('#serviceTel').val()+'，我们会竭诚为您服务。</div></div>');com_bug.appendTo("body");com_bug.css({top:_top,left:_left});com_bug.click(function(e){stopPropagation(e);});return false;}
if(dateDiff('D',newDateStr,$checkoutdate)>271){$('#com_bug').remove();$checkoutdateDom.addClass("err");var _left=$checkoutdateDom.offset().left+138;var _top=$checkoutdateDom.offset().top;var com_bug=$('<div id="com_bug" class="com_bug"><span class="shdaw"></span><div class="w">如果您需预订'+$checkoutdate+'的酒店，请致电：'+$('#serviceTel').val()+'，我们会竭诚为您服务。</div></div>');com_bug.appendTo("body");com_bug.css({top:_top,left:_left});com_bug.click(function(e){stopPropagation(e);});return false;}
if(dateDiff('D',$checkindate,$checkoutdate)>28){$('#com_bug').remove();$checkoutdateDom.addClass("err");var _left=$checkoutdateDom.offset().left+138;var _top=$checkoutdateDom.offset().top;var com_bug=$('<div id="com_bug" class="com_bug"><div class="w">您入住的酒店时间超过28天，请分订单提交预订!</div></div>');com_bug.appendTo("body");com_bug.css({top:_top,left:_left});com_bug.click(function(e){stopPropagation(e);});return false;}
hotelCommon.reload();return;}
function dateDiff(interval,date1,date2){var objInterval={'D':1000*60*60*24,'H':1000*60*60,'M':1000*60,'S':1000,'T':1};interval=interval.toUpperCase();var dt1=Date.parse(date1.replace(/-/g,'/'));var dt2=Date.parse(date2.replace(/-/g,'/'));try{return Math.round((dt2-dt1)/eval('(objInterval.'+interval+')'));}catch(e){return e.message;}}
function stopPropagation(e){e=e||window.event;if(e.stopPropagation){e.stopPropagation();}else{e.cancelBubble=true;}}
function online_order_login(){tel=$("#tourist_tel").val();orderLogin.isLogin('','orderLogin.login_back_4','orderLogin.tel_back_4','',tel);}
function reg_phone_check(tel){var tel=$("#tourist_tel").val();var result=orderLogin.show_reg_phone_check('','orderLogin.login_back_4','orderLogin.tel_back_4',tel);}
function GetDateStr(pdate){var dd=pdate;var y=dd.getYear();y=y%100;y=((y<50)?(2000+y):(1900+y));var m=dd.getMonth()+1;var d=dd.getDate();return y+"-"+m+"-"+d;}
function readCookie(name){var nameEQ=name+"=";var ca=document.cookie.split(';');for(var i=0;i<ca.length;i++){var c=ca[i];while(c.charAt(0)==' ')c=c.substring(1,c.length);if(c.indexOf(nameEQ)==0)return c.substring(nameEQ.length,c.length);}
return null;}
function createCookie(name,value,days){var expires="";if(days){var date=new Date();date.setTime(date.getTime()+(days*24*60*60*1000));expires="; expires="+date.toGMTString();}
document.cookie=name+"="+value+expires+"; path=/";}
function showBookingTips(){$('.icon_tip').live({mouseenter:function(){utip=$(this).next('.popTip');if(utip.length){$('.d_popBox').length>0?tip=$('.d_popBox'):tip=$('<div class="d_popBox"></div>').appendTo('body');tip.html(utip.html());tip.show();}},mouseleave:function(){tip=$('.d_popBox')
if(tip.length){tip.hide();}},mousemove:function(e){tip=$('.d_popBox')
if(tip.length){var mousex=e.pageX+20;var mousey=e.pageY;var tipWidth=tip.outerWidth();var tipHeight=tip.outerHeight();var tipVisX=$(window).width()-(mousex+tipWidth);var tipVisY=$(window).height()-(mousey+tipHeight);if(tipVisX<20){mousex=e.pageX-tipWidth-20;}
if(tipVisY<0){mousey=e.pageY-tipHeight;}
tip.css({top:mousey,left:mousex});}}})};$(function(){var $input=$('#tourist_tel'),$show=$('.shadow_tel');$input.on({'keyup focus':function(){var sNum=this.value&&this.value.replace(/^(\w{3})|([\w\s]{4})/g,function(num){return num+' ';});if($.trim(this.value).length){$('.shadow_tel').text(sNum).show();}
else{$show.hide();}},'blur':function(){$show.hide();}});$(document).delegate('.need_invoice','click',function(){if(3!=$('#businessType').val()){return;}
var $icon=$(this).children(),$invoice=$('.fapiao_con');$icon.toggleClass('selected');if($icon.hasClass('selected'))
$invoice.show();else
$invoice.hide();});$('#cashbackInfo').on('click','.travel-coupon .box',function(){$(this).toggleClass('box-selected');$('#use_price').toggleClass('hide');$('#use_price').val('');$('#cashbackInfo .travel-coupon .price').toggleClass('hide');if(!$(this).hasClass('box-selected')){renderPrice();}});window.addPromotionCode=function(){$.layer({type:1,fix:true,title:['添加优惠券'],move:false,border:[0],border:[2,0.3,'#DDD'],shade:[0.5,'#000'],area:['375px','auto'],page:{dom:'.addPromotion'}});};var checkPromotion=function(){var $ele=$('#promotion_code'),$err=$('#check_promotion_show');window.isCanPromotion=false;if(!$.trim($ele.val()).length){$err.text('请输入优惠券。');$err.css('display','block');window.isCanPromotion=false;}else{$err.hide();window.isCanPromotion=true;}};$('#promotion_code').on({'keyup':checkPromotion,'blur':checkPromotion});$('.btnField .submit').on('click',function(){checkPromotion();if(!window.isCanPromotion){return;}
$.ajax({url:'/yii.php?r=hotel/ajax/bindPromotionCode',data:{custId:$('#customerId').val(),codeId:$('#promotion_code').val()},type:'post',dataType:'JSON',success:function(info){if(info.success===true){layer.closeAll();layer.msg('添加成功!');ajaxPromotionCode();}else{$('#check_promotion_show').text(info.msg);$('#check_promotion_show').css('display','block');}}});});$('.btnField .cancel').on('click',function(){layer.closeAll();});$('.acceptTerms').on('click',function(e){e.preventDefault();$.layer({type:1,title:['途牛酒店产品预订条款'],move:false,fix:false,border:[2,0.3,'#DDD'],shade:[0.5,'#000'],area:['675px','735px'],page:{dom:'#terms'}});});$('#noRoomPaid').find('a').on('click',function(e){e.preventDefault();$.layer({type:1,title:['途牛酒店产品服务承诺和赔付标准'],fix:false,move:false,border:[2,0.3,'#DDD'],shade:[0.5,'#000'],area:['675px','735px'],page:{dom:'#noRoomPaidContent'}});});$('#minus').click(hotel_order.roomNumMinus);$('#plus').click(hotel_order.roomNumPlus);hotel_order.pricePlan();hotelCommon.autoComplete(1);hotel_order.change_fapiao();if($('#houseNum').length>0){$('#houseNum').change(hotel_order.roomNumSelect);}
if($('#cashbackInfo .order_table tr:not(.cashBackBlock)').length>0){$('#cashbackInfo').show();}});var hotel_order={_gaq:_gaq||[],roomNumChange:function(){var roomNumLimit=hotel_order.formatInt($('#roomNum').val());var roomNumMax=(roomNumLimit<8)?roomNumLimit:8;var roomNumMin=(roomNumLimit>0)?1:0;var houseNum=hotel_order.formatInt($('#houseNum').val());var flag=0;if(roomNumMax==roomNumMin){houseNum=roomNumMax;$('#houseNum').val(houseNum);if($('.minus').hasClass('limit')){}else{$('.minus').addClass('limit').unbind('click');}
if($('.plus').hasClass('limit')){}else{$('.plus').addClass('limit').unbind('click');}
hotel_order.roomNumGuarantee();hotel_order.showSummary();hotel_order.showPolicyFee();hotelCommon.autoComplete();hotelCommon.autoComplete(1);return false;}
if(roomNumMin>=houseNum){houseNum=roomNumMin;$('#houseNum').val(houseNum);if($('.minus').hasClass('limit')){}else{$('.minus').addClass('limit').unbind('click');}
flag=1;}
if(roomNumMax<=houseNum){houseNum=roomNumMax;$('#houseNum').val(houseNum);if($('.plus').hasClass('limit')){}else{$('.plus').addClass('limit').unbind('click');}
flag=2;}
if(1==flag){if($('.plus').hasClass('limit')){$('.plus').removeClass('limit').click(hotel_order.roomNumPlus);}}else if(2==flag){if($('.minus').hasClass('limit')){$('.minus').removeClass('limit').click(hotel_order.roomNumMinus);}}else{if($('.plus').hasClass('limit')){$('.plus').removeClass('limit').click(hotel_order.roomNumPlus);}
if($('.minus').hasClass('limit')){$('.minus').removeClass('limit').click(hotel_order.roomNumMinus);}}
hotel_order.roomNumGuarantee();var rz_people=$("ul#rz_people li").length||$("#rz_people input").length;var rz_nation=$("#rz_nation").find("input").length;hotel_check.init_rz_num(rz_people,houseNum);hotel_order.nameUniq();hotel_check.init_rz_nation(rz_nation,houseNum);hotel_order.showSummary();hotel_order.showPolicyFee();hotelCommon.autoComplete();hotelCommon.autoComplete(1);},nameUniq:function(){var mainland=$("#mainland").val();var tourist=$("#rz_people").children();if(tourist.length>=2){if(mainland==1){tourist.each(function(index,element){$(element).blur(function(){for(var i=0;i<tourist.length;i++){if((i!=index)&&((tourist.eq(i).val()==tourist.eq(index).val()))){$("#rz_name_tip .msg").text('请填写不同的入住人姓名，以确保顺利入住');$("#rz_name_tip").show();}}});});}else{tourist.each(function(index,element){$(element).children().blur(function(){for(var i=0;i<tourist.length;i++){if((i!=index)&&(tourist.eq(i).children().eq(0).val()+tourist.eq(i).children().eq(1).val()).toLowerCase()==(tourist.eq(index).children().eq(0).val()+tourist.eq(index).children().eq(1).val()).toLowerCase()){$("#rz_name_tip .msg").text('请填写不同的入住人姓名，以确保顺利入住');$("#rz_name_tip").show();}}});});}}},checkName:function(){var mainland=$("#mainland").val();var tourist=$("#rz_people").children();var touristName=[];if(mainland==1){tourist.each(function(index,element){touristName.push($(element).val());});}else{tourist.each(function(index,element){touristName.push($(element).children().eq(0).val()+$(element).children().eq(1).val());});}
if(touristName.length>=2){for(var i=0;i<touristName.length;i++){for(var j=0;j<touristName.length;j++){if((i!=j)&&(touristName[i].toLowerCase()==touristName[j].toLowerCase())){return false;}}}}
return true;},roomNumGuarantee:function(){if($('.house_select').length>0){var guaranteeRoomNum=hotel_order.formatInt($('#guaranteeRoomNum').val());var guaranteeMin=hotel_order.formatInt($('#allowMaxRoomNum').val());var houseNum=hotel_order.formatInt($('#houseNum').val());if(guaranteeRoomNum&&guaranteeMin){if(houseNum>guaranteeMin){$('#hold_tag').attr('val',1).hide();$('.house_select').hide();var newDateStr=GetDateStr(new Date());var $checkoutdate=$('#end_date').val();if(dateDiff('D',newDateStr,$checkoutdate)>=26){$('#g_next').hide();$('#g_empty').show();}}else{$('#hold_tag').attr('val',0).show();$('.house_select').show();$('#g_empty').hide();$('#g_next').show();}}
var guaranteeInFact=$('#hold_tag').attr('val');$('#guaranteeInFact').val(guaranteeInFact);}},showSummary:function(){var houseNum=hotel_order.formatInt($('#houseNum').val());var roomPriceJson=$('#roomPrice').val();try{var roomPriceObj=$.parseJSON(roomPriceJson);}catch(e){}
var checkinDate=$('#begin_date').val();var checkinDateObj=hotel_order.parseDate(checkinDate);var checkoutDate=$('#end_date').val();var checkoutDateObj=hotel_order.parseDate(checkoutDate);var duration=(checkoutDateObj-checkinDateObj)/(24*60*60*1000);var breakfastDesc=$('#breakfastDesc').val();var singleGuaranteeFee=parseFloat($('#guaranteeFee').val());var singleCashBacked=hotel_order.formatInt($('#cashBacked').val());var isPriceOk=true;var totalPrice=0;var currencyType='';var totalForeignPrice=0;var summaryHtml='';var guaranteeFee=singleGuaranteeFee*houseNum;var summary=new Array();for(var day=0;day<duration;day++){var i_time=checkinDateObj.getTime()+day*24*60*60*1000;var i_dateObj=new Date(i_time);var i_year=i_dateObj.getFullYear();var i_month=i_dateObj.getMonth()+1;var i_day=i_dateObj.getDate();i_month=i_month<10?'0'+i_month:i_month;i_day=i_day<10?'0'+i_day:i_day;var i_date=i_year+'-'+i_month+'-'+i_day;if(roomPriceObj==null||roomPriceObj[i_date]==null||roomPriceObj[i_date].priceAdult<0){isPriceOk=false;continue;}
var i_price=roomPriceObj[i_date].priceAdult;var i_old_price=roomPriceObj[i_date].oldPrice;var i_cashBack=roomPriceObj[i_date].cashBacked;var i_foreign_price=roomPriceObj[i_date].foreignCurrencyPriceAdult;var dailyPrice=houseNum*i_price;var dailyForeignPrice=houseNum*i_foreign_price;totalPrice+=houseNum*i_old_price;currencyType=roomPriceObj[i_date].currencyType;totalForeignPrice+=dailyForeignPrice;dailyPrice=parseFloat(dailyPrice).toFixed(2);dailyForeignPrice=parseFloat(dailyForeignPrice).toFixed(2);summary.push({price:parseInt(i_price),cashBack:parseInt(hotel_order.formatFloat(i_cashBack)),breakfast:roomPriceObj[i_date].breakfastDesc,week:i_dateObj.getDay(),date:i_month+'-'+i_day,houseNum:houseNum});}
totalPrice=Math.ceil(totalPrice);$('#totalPrice').val(totalPrice);var cashBacked=singleCashBacked*houseNum;if(!isPriceOk){$('.cashBackBlock').hide();$('#hotel_base_info .reachTime').attr('disabled',true);$('#hotel_base_info .guaranteeRule').hide();$('#realPrice,.totalPrice').add($('.invoice_price')).text('￥--');$('#g_empty').show();$('#normalError').show();return;}
function setSummaryHtml(summary){if(!summary){return;}
var cashBackth='';var th='';var rows='';var cashBackRow='';var weekName=['日','一','二','三','四','五','六'];for(var i=0,len=summary.length;i<len;i++){if(i<7)th+='<li>'+weekName[summary[i].week]+'</li>';rows+='<li><em>'+summary[i].date+'</em><span>￥'+summary[i].price+'</span>';if(summary[i].breakfast)rows+='<i>('+summary[i].breakfast+')</i></li>';cashBackRow+='<li><em>'+summary[i].date+'</em><span>返 ￥'+summary[i].cashBack+'</span></li>';}
var begin=summary[0].week;for(var p=0;p<7;p++){cashBackth+='<li>'+weekName[begin%7]+'</li>';begin++;}
$('#roomSummary ol').html(th);$('#cashbackSummary ol').html(cashBackth);$('#roomSummary ul').html(rows);$('#cashbackSummary ul').html(cashBackRow);renderPrice();if(cashBacked)
$('#roomSummary .caseBackInfo').show();}
var oldprice=Number($("#oldprice").val());var nowprice=Number($("#avgPrice").val());if(oldprice&&oldprice>0&&nowprice>0){if(oldprice!=nowprice){var text='';if(oldprice<nowprice){text="实时房价变更频繁，"+"原价￥"+oldprice+"/晚，已变更为￥"+nowprice+"/晚。";}else{var price=oldprice-nowprice;text="实时房价变更频繁，已为您节省￥"+price*duration*houseNum+"，原价￥"+oldprice+"/晚，降至￥"+nowprice+"/晚。"}
$(".price_change").css("display","block");$(".price_change span").html(text);}else{$(".price_change").css("display","none");}}else{$(".price_change").css("display","none");}
setSummaryHtml(summary);totalPrice=parseFloat(totalPrice).toFixed(2);totalForeignPrice=parseFloat(totalForeignPrice).toFixed(2);guaranteeFee=parseFloat(guaranteeFee).toFixed(2);$('#total_price').html(totalPrice);$('#currencyType').val(currencyType);$('#totalForeignPrice').val(totalForeignPrice);$('#invoiceAmount').val(totalPrice);$('.guarantee_fee').html(guaranteeFee);var $guaranteeRule=$('#guaranteeFeePolicyBlock .guaranteeRule').clone();$guaranteeRule.find('.icon_tip').remove();$guaranteeRule.find('.popTip').remove();$('#guaranteeFeePolicy').val($guaranteeRule.text().replace('担保条件',''));if(cashBacked){$('.cashBackBlock, .cashback').show();$('.cashBackTotal').html('￥'+cashBacked.toFixed(2));$('#hotelcashback').html('￥'+cashBacked.toFixed(2));$('#cashbackInfo').show();}else{$('.cashback').hide();$('.cashBackBlock').hide();$('.cashBackTotal').html('￥00.00');$('#hotelcashback').html('￥00.00');}
if($("#user_islogin").val()>0){$("#extra_login_entry").hide();$("#cashBackRule").show();}else{$("#extra_login_entry").show();$("#cashBackRule").hide();}},showPolicyFee:function(){var houseNum=hotel_order.formatInt($('#houseNum').val());var policyFee=hotel_order.formatFloat($('#policyFee').val());if(policyFee>0){var totalPocilyFee=houseNum*policyFee;$('#policyFeeHtml').html(totalPocilyFee.toFixed(2));}},formatInt:function(num){num=parseInt(num);num=isNaN(num)?0:num;return num;},formatFloat:function(num){num=parseFloat(num);num=isNaN(num)?0:num;return num;},parseDate:function(dateStr){var date=dateStr.split('-')
return new Date(date[0],date[1]-1,date[2]);},change_fapiao:function(){if(3!=$('#businessType').val()){return;}
if(document.getElementsByName('check_fapiao').length>1&&document.getElementsByName('check_fapiao')[1].checked==true){$('.fapiao_con').show();}else{$('.fapiao_con').hide();}},no_fapiao:function(){if(document.getElementsByName('check_fapiao').length>0&&document.getElementsByName('check_fapiao')[0].checked==true){$('.fapiao_con').hide();}else{$('.fapiao_con').show();}},check_invoice_title:function(){var title=$("#invoice_title").val();var formEle=$('#invoice_title');var tip=$('#invoice_title_tip');title=title.replace(/(^\s*)/g,"");if(title==''||title=='个人'||title=='客人'||title=='客户'||title=='单位'||title=='公司'||title=='顾客'||title=='部队'||title=='医院'||title=='政府'){this.showErr(formEle,tip,'请填写正确的个人姓名或公司全称');return false;}else if(/^南京途牛国际旅行社有限公司$/g.test(title.replace(/\s+/g,''))){this.showErr(formEle,tip,'南京途牛国际旅行社有限公司的员工无需开具发票，提报时直接填写订单号即可。');return false;}
this.hideErr(formEle,tip);return true;},check_invoice_address:function(){var address=$("#invoice_address").val();var formEle=$('#invoice_address');var tip=$('#invoice_address_tip');address=address.replace(/(^\s*)/g,"");if(address==''||address==='街道+门牌号+大厦或小区名称+楼号+单元+房间号+公司名称'){this.showErr(formEle,tip,'请填写邮寄地址');return false;}
this.hideErr(formEle,tip);return true;},check_invoice_receiver:function(){var creditName=$('#invoice_receiver').val();var formEle=$('#invoice_receiver');var tip=$('#invoice_receiver_tip');var result=$.TN_checkName(creditName);switch(result){case 1:this.hideErr(formEle,tip);return true;break;case 2:this.showErr(formEle,tip,'请填写姓名');return false;break;case 3:this.showErr(formEle,tip,'姓名长度请在4-20字符内（1个汉字等于2个字符）');return false;break;default:this.showErr(formEle,tip,'姓名只能包含中文、英文和空格');return false;break;}},check_invoice_tel:function(){var tel=$("#invoice_tel").val();var formEle=$('#invoice_tel');var tip=$('#invoice_tel_tip');var result=$.TN_checkTel(tel);switch(result){case 1:this.hideErr(formEle,tip);return true;break;default:this.showErr(formEle,tip,'请填写正确的手机号码!');return false;break;}},check_invoice_code:function(){var code=$("#invoice_code").val();var formEle=$('#invoice_code');var tip=$('#invoice_code_tip');var reg=/^[0-9]{6}$/;if(!reg.test(code)){this.showErr(formEle,tip,'请填写正确的邮政编码');return false;}
this.hideErr(formEle,tip);return true;},check_invoice_info:function(){if($('.need_invoice i').hasClass('selected')){if($("#invoiceAmount").val()==0||$("#invoiceAmount").val()==-1){$("#invoiceNeed").attr("value","no");return true;}else{if(!this.check_invoice_title()||!this.check_invoice_receiver()||!this.check_invoice_tel()||!this.check_invoice_address()||!this.check_invoice_code()){if(window.location.hash=="#hotel_invoice"){window.location.hash="#";}
window.location.hash="#hotel_invoice";return false;}
var province=$("#province").val();var city=$("#city").val();var area=$("#area").val();if('北京'==province||'上海'==province||'天津'==province||'重庆'==province){city=area;}
if('台湾'==province){area='';}
$("#invoiceProvince").attr("value",province);$("#invoiceCity").attr("value",city);$("#invoiceArea").attr("value",area);$("#invoiceAddress").attr("value",$("#invoice_address").val());$("#invoiceCode").attr("value",$("#invoice_code").val());$("#invoiceTitle").attr("value",$("#invoice_title").val());$("#invoiceReceiver").attr("value",$("#invoice_receiver").val());$("#invoiceTel").attr("value",$("#invoice_tel").val());$("#invoiceNeed").attr("value","yes");return true;}}else{$("#invoiceAmount").attr("value",-1);return true;}},checkDateNum:function(){var isDateOk=hotel_order.formatInt($('#isDateOk').val());var isDateNumOk=hotel_order.formatInt($('#isDateNumOk').val());if(isDateOk==0||isDateNumOk==0){if(window.location.hash=="#hotel_base_info"){window.location.hash="#";}
window.location.hash="#hotel_base_info";return false;}
return true;},get_use_price:function(){$("#use_price_tip").hide();var use_price=$("#use_price").val();var reg=/^[0-9]+$/gi;if(!use_price.match(reg)){$("#use_price_tip").find("span").text("您输入的金额有误，请重新输入");$("#use_price_tip").show();$("#use_price").val('');return-1;}
use_price=hotel_order.formatInt(use_price);var use_price_begin=hotel_order.formatInt($("#use_price_begin").val());var travel_left_coupon=hotel_order.formatInt($("#travel_left_coupon").val());var group_cost_show=hotel_order.formatInt($("#totalPrice").val());if(use_price<0){$("#use_price_tip").find("span").text("您输入的金额有误，请重新输入");$("#use_price_tip").show();use_price=0;$("#use_price").val(use_price);return-1;}
if(use_price>travel_left_coupon){$("#use_price_tip").find("span").text("使用金额不得超出可用余额，请重新输入");$("#use_price_tip").show();use_price=0;$("#use_price").val(use_price);return-1;}
if(use_price>(group_cost_show+use_price_begin)){$("#use_price_tip").find("span").text("不得超出当前使用金额，请重新输入");$("#use_price_tip").show();use_price=0;$("#use_price").val(use_price);return-1;}
return use_price;},travelCouponUseClose:function(){$('.verification_mes_box').hide();$('#use_price').val(0);var $icon=$(".need_travelCoupons").children();$icon.toggleClass('selected');},changePrice:function(totalPrice,usePrice){var totalPrice=totalPrice||parseFloat($('#totalPrice').val());var travelCoupon=usePrice||hotel_order.formatInt($('#use_price').val());var realPrice=totalPrice;$('.travelCoupons_cut').text('￥'+$('#use_price').val());$('#cashBack').text($('#use_price').val());if(0>=totalPrice){$('#g_next').hide();$('#g_empty').show();}
realPrice=parseFloat(realPrice).toFixed(2);if(0>=realPrice){realPrice='--';$('#use_price').val(0);}
$('#realPrice,.totalPrice,.invoice_price').html('￥'+realPrice);$('#g_next').show();$('#g_empty').hide();var currencyType=$('#currencyType').val();if($.inArray(currencyType,['USD','HKD','MOP','SGD'])>-1){var foreignCurrency=[];foreignCurrency['RMB']=['人民币','￥'];foreignCurrency['USD']=['美元','USD'];foreignCurrency['HKD']=['港币','HKD'];foreignCurrency['MOP']=['澳门币','MOP'];foreignCurrency['SGD']=['新加坡元','SGD'];var foreignCurrencyStr='<b>'+foreignCurrency[currencyType][0]+'</b>'+'<i class="yh">'+foreignCurrency[currencyType][1]+parseFloat($('#totalForeignPrice').val()).toFixed(2)+'</i>'+'元';$('#realForeignPrice').html(foreignCurrencyStr);}},checkCreditNum:function(){var creditNum=$('#credit_num').val().replace(/\s+/g,"");if(''!=creditNum){var reg=/^[0-9]{16}$/;if(!reg.test(creditNum)){$("#credit_num_tip").show();$("#credit_num_tip").html('请填写正确的信用卡卡号');return false;}}else{$("#credit_num_tip").show();$("#credit_num_tip").html('请填写信用卡卡号');return false;}
$("#credit_num_tip").hide();$("#credit_num_tip").html('');return true;},checkCreditName:function(){var creditName=$('#credit_name').val();var result=$.TN_checkName(creditName);$("#credit_name_tip").html('');switch(result){case 1:$("#credit_name_tip").hide();$("#credit_name_tip").html('');return true;break;case 2:$("#credit_name_tip").show();$("#credit_name_tip").html('请填写姓名');return false;break;case 3:$("#credit_name_tip").show();$("#credit_name_tip").html('姓名长度请在4-20字符内（1个汉字等于2个字符）');return false;break;default:$("#credit_name_tip").show();$("#credit_name_tip").html('姓名只能包含中文、英文和空格');return false;break;}},checkSpecialNum:function(){var cvv2=$('#credit_special_num').val().replace(/\s+/g,"");if(''!=cvv2){var reg=/^[0-9]{3}$/;if(!reg.test(cvv2)){$("#credit_special_num_tip").show();$("#credit_special_num_tip").html('请填写正确的CVV2号');return false;}}else{$("#credit_special_num_tip").show();$("#credit_special_num_tip").html('请填写CVV2号');return false;}
$("#credit_special_num_tip").hide();$("#credit_special_num_tip").html('');return true;},checkPaperNum:function(){var paperNum=$('#paper_num').val();if(''!=paperNum){var result=$.TN_checkIdCard(paperNum);if(15!=result&&18!=result){$("#paper_num_tip").show();$("#paper_num_tip").html('请填写正确的证件号码');return false;}}else{$("#paper_num_tip").show();$("#paper_num_tip").html('请填写证件号码');return false;}
$("#paper_num_tip").hide();$("#paper_num_tip").html('');return true;},checkCreditCard:function(){$('#g_next').attr('disabled',true);var selectedCard=$('#payCard ul.cardList li.on');if(selectedCard.length>0){var bankName=selectedCard.attr('val');$('#creditBank').val(bankName);}else{$("#credit_bank_tip").show();$("#credit_bank_tip").html('请选择担保银行');$('#g_next').attr('disabled',false);if(window.location.hash=="#credit_card_info"){window.location.hash="#";}
window.location.hash="#credit_card_info";return false;}
if(hotel_order.checkCreditNum()&&hotel_order.checkCreditName()&&hotel_order.checkPaperNum()&&hotel_order.checkSpecialNum()){orderGuarantee();}else{$('#g_next').attr('disabled',false);return false;}},back:function(){var hotelId=$('#hotelId').val();var roomId=$('#roomId').val();var checkinDate=$('#checkinDate').val();var checkoutDate=$('#checkoutDate').val();window.location.href='/order/order/?hotel='+hotelId+'&room='+roomId+'&checkindate='+checkinDate+'&checkoutdate='+checkoutDate;return false;},showErr:function(formEle,tip,errMsg){formEle.addClass('err');tip.find('.msg').html(errMsg);tip.show();},hideErr:function(formEle,tip){formEle.removeClass("err");tip.hide().find('.msg').html('');},pricePlan:function(){var nodes=$('#realPrice').add($('#contentTotalPrice'));nodes.each(function(){var roomSummary=$($(this).attr('hover'));$(this).hover(function(e){var iLeft=this.getBoundingClientRect().left,iTop=this.getBoundingClientRect().top;roomSummary.css({position:'fixed',left:iLeft-500-$(this).width()/2,top:iTop+$(this).height()+5,display:'block'});if(parseInt($('#agencyId').val())==30258||$('#hasTaxOrServiceFee').val()){roomSummary.find('.price-calendar-footer').css({width:roomSummary.find('ol').width()-22,display:'block'});var str='';if(parseInt($('#agencyId').val())==30258)str+='日均价做取整展示，实际支付以总价为准。';if($('#hasTaxOrServiceFee').val())str+='该价格包含税和服务费，该价格仅供'+$('#adultNum').val()+'位成人，儿童、及更多成人可能被额外收费';roomSummary.find('.price-calendar-footer').text(str);}
if(roomSummary.find('ol li').get(0)){roomSummary.fadeIn(300);}},function(){roomSummary.fadeOut(300);});});}}
function HotelBook(){var self=this;this.hotelId=$('#hotel_resource_id').val();this.roomId=$('#room_resource_id').val();this.checkInDate=$('#begin_date').val();this.checkOutDate=$('#end_date').val();this.roomNum=$('#roomNum').val();this.productId=$('#productId').val();this.productType=$('#productType').val();this.businessType=$('#businessType').val();this.reachTimeEle=$('#reachTimeSelect .reachTime');this.roomNumEle=$('#houseNum');this.isCanBook=false;this.loadObj;function getRealtimeInfo(param,callBack){self.loadObj.start();var data=$.extend({hotel:self.hotelId,room:self.roomId,roomNum:$('#houseNum').val()?$('#houseNum').val()-0:1,checkindate:self.checkInDate,checkoutdate:self.checkOutDate,productId:self.productId,productType:self.productType,businessType:self.businessType,productLineId:$('#productLineId').val(),pValue:$('#pValue').val(),customerId:$('#customerId').val(),brandId:$('#brandId').val(),oldPrice:$('#oldprice').val(),cityCode:$('#bookCityCode').val()},param);$('.cashBackBlock, .cashback').hide();if(1==$('#cashbackInfo .order_table tr').length){$('#cashbackInfo').hide();}
$('#guaranteeFeePolicyBlock').hide();$('#g_next').hide();$('#extra_login_entry').hide();$("#cashBackRule").show();$.ajax({url:'/ajax/roomRealtimeInfo',data:data,dataType:'JSON',success:function(info){var data=info.data;var text='';$("#normalError").hide();if(info&&info.success){if(data.salesType!=0){if(data.salesType==6){if(data.canBook&&data.advancedBookingOffset<=data.roomNum){$('#price_limit_plan_mind_info_about_rooms_tr').show();$('#price_limit_plan_mind_info_about_rooms').text(data.salesText);}else{if(data.advancedBookingOffset<data.roomNum){$('#realPrice,.totalPrice,.invoice_price').html('￥--');$("#normalError").show();return;}else{$('#realPrice,.totalPrice,.invoice_price').html('￥--');$('#normalError span').text(data.salesText);$("#normalError").show();return;}}}else{if(data.canBook&&data.roomNum>0){$('#price_limit_plan_mind_info_about_nights_tr').show();$('#price_limit_plan_mind_info_about_nights').text(data.salesText);}else{if(data.roomNum<=0){$('#realPrice,.totalPrice,.invoice_price').html('￥--');$("#normalError").show();return;}else{$('#realPrice,.totalPrice,.invoice_price').html('￥--');$('#normalError span').text(data.salesText);$("#normalError").show();return;}}}}
processControl(info.data['businessType'],info.data['isGuarantee'],info.data['isJibaofang']);renderPromotion(info.data['promotionCodeInfo']);callBack(info.data);renderPrice();}
self.loadObj.stop();if(info.msg){$('#realPrice,.totalPrice,.invoice_price').html('￥--');$("#normalError").show();$('#cashbackInfo').hide();}},error:function(){$('#cashbackInfo').hide();}});};function processControl(businessType,isGuarantee,isJibaofang){if(businessType-0===3){if(isJibaofang-0){$('.steps li:eq(0)').removeClass('invalid').removeClass('brief').addClass('effect');$('.steps li:eq(1)').removeClass('invalid').removeClass('effect').addClass('invalid').find('.content').text('支付订单');$('.steps li:eq(2)').show().removeClass('invalid').removeClass('effect').addClass('invalid').find('.content').text('提交成功');}else{$('.steps li:eq(0)').removeClass('invalid').removeClass('brief').addClass('effect');$('.steps li:eq(1)').removeClass('invalid').removeClass('effect').addClass('invalid').find('.content').text('提交成功');$('.steps li:eq(2)').show().removeClass('invalid').removeClass('effect').addClass('invalid').find('.content').text('支付订单');}}else{if(isGuarantee-0){$('.steps li:eq(0)').removeClass('invalid').removeClass('brief').addClass('effect');$('.steps li:eq(1)').removeClass('invalid').removeClass('effect').addClass('invalid').find('.content').text('担保订单');$('.steps li:eq(2)').show().removeClass('invalid').removeClass('effect').addClass('invalid').find('.content').text('提交成功');}else{$('.steps li:eq(0)').removeClass('invalid').removeClass('brief').addClass('effect');$('.steps li:eq(1)').removeClass('invalid').removeClass('effect').addClass('brief').find('.content').text('提交成功');$('.steps li:eq(2)').hide();}}};function updatePrice(){hotel_order.roomNumChange();}
function updateReachTime(lastTimeArr){if(!lastTimeArr)
return;var reachTimeSelect=$('#reachTimeSelect');var guaranteeMsg=reachTimeSelect.find('.guaranteeRule');var lastCheckInTime=lastTimeArr.lastCheckInTime;$('#hold').val(lastCheckInTime);var daysList=lastTimeArr.daysList;var optionStr='';for(var i=0,len=daysList.length;i<len;i++){optionStr+='<option '+(daysList[i].selected?'selected':'')+' value="'+daysList[i].value+'">'+
daysList[i].name+'</option>';}
self.reachTimeEle.html('').append(optionStr).attr('disabled',false);reachTimeSelect.show();guaranteeMsg.hide()
if(lastTimeArr.msg){guaranteeMsg.show().text(lastTimeArr.msg);}}
function updateGuaranteePolicy(isGuarantee,businessType,guaranteeFeePolicy){var guaranteeNode=$('#guaranteeFeePolicyBlock');if(isGuarantee&&guaranteeFeePolicy){guaranteeNode.find('.guaranteeContent').text(guaranteeFeePolicy);guaranteeNode.show();}else if(businessType==3&&guaranteeFeePolicy){guaranteeNode.find('.icon_tip').remove();guaranteeNode.find('.popTip').remove();guaranteeNode.find('.guaranteeContent').text(guaranteeFeePolicy);guaranteeNode.show();}}
function updateRoomNum(roomNum,salesType,advancedBookingOffset){var roomNumEle=self.roomNumEle;var parentNode=roomNumEle.parent();var leftRoomNumTips=parentNode.find('.leftRoomNumTips');var fullRoomTips=parentNode.find('.fullRoomTips');var selectorDialog=parentNode.find('.selector_dialog');var selectHandle=parentNode.find('.selectHandle');selectHandle.removeClass('leftRoomNum1').text('');leftRoomNumTips.hide();fullRoomTips.hide();if(roomNum<1){roomNumEle.attr('disabled',true);fullRoomTips.show();$("#normalError").show();return;}
if(roomNum<8)
leftRoomNumTips.show().find('em').text(roomNum);if(1==roomNum){selectHandle.addClass('leftRoomNum1').text(1);roomNumEle.attr('disabled',false).attr('readOnly',true);roomNumEle.html('').append('<option value="1">1</option>');selectorDialog.find('ul').html('');return;}
var min=1,max=roomNum>8?8:roomNum;if(salesType==6){min=advancedBookingOffset;}
roomNumEle.attr('disabled',false).attr('readOnly',false);var optionStr=liStr='';var selectNum=roomNumEle.attr('param');roomNumEle.val()?selectNum=roomNumEle.val():'';for(var i=min;i<=max;i++){optionStr+='<option '+(i==selectNum?'selected':'')+' value="'+i+'">'+i+'</option>';liStr+='<li '+(i==selectNum?'class="selected"':'')+' value="'+i+'">'+i+'</li>';}
selectorDialog.find('p').hide();if(roomNum>=8)
selectorDialog.find('p').show();roomNumEle.html('').append(optionStr);selectorDialog.find('ul').html('').append(liStr);}
function update(data){self.loadObj.stop();data.needNationality?$('#needNationality').data('need',true).show():$('#needNationality').data('need',false).hide();$('#guarantee_time').val(data.guaranteeTime);$('#businessType').val(data.businessType)
$('#guaranteeFee').val(data.guaranteeFee);$('#guaranteeInFact').val(data.guaranteeInFact);$('#isJiBaoFang').val(data.isJibaofang);$('#agencyId').val(data.vendorId);$('#cancelRule').val(data.cancellationPolicy);$('#guaranteeFeePolicy').val(data.guaranteeFeePolicy);$('#policyFee').val(data.policyFee);$('#cashBacked').val(data.cashBacked);$('#roomNum').val(data.roomNum);$('#allowMaxRoomNum').val(data.guaranteeMaxRoomNum);$('#guaranteeRoomNum').val(data.guaranteeRoomNum);$('#form [name=token]').val(data.token);$('#roomPrice').val(data.roomPriceJson);$('#avgPrice').val(data.avgPrice);if(data.hasTaxOrServiceFee)$('#hasTaxOrServiceFee').val(1);if(data.hotelTips){$('.to_hotel').show().find('.notice p').html(data.hotelTips.replace("酒店提示\n",''));}
updateRoomNum(data.roomNum,data.salesType,data.advancedBookingOffset);updateReachTime(data.lastTimeArr);var tmpPolicyRule=$.trim(data.guaranteeFeePolicy);if(tmpPolicyRule==''){tmpPolicyRule=$.trim(data.cancellationPolicy);}
updateGuaranteePolicy(data.isGuarantee,data.businessType,tmpPolicyRule);updatePrice();var startDate=$('#begin_date').val(),endDate=$('#end_date').val(),sMatch=startDate.match(/-(\d+)?-/)[1],eMatch=endDate.match(/-(\d+)?-/)[1];if(sMatch-0<10&&sMatch.length!=2){startDate=startDate.replace(/-(\d+)?-/,function(a){return'-0'+sMatch+'-';})}
if(eMatch-0<10&&eMatch.length!=2){endDate=endDate.replace(/-(\d+)?-/,function(a){return'-0'+eMatch+'-';})}
var sHref=$('.title a')[0].href+'?checkindate='+startDate+'&checkoutdate='+endDate;$('.title a').add($('.anewSelect')).attr('href',sHref);$('.orderTotalBlock .cashBackBlock').show();if($("#user_islogin").val()>0){init_favors();}}
function loading(nodeList){var html=$('<span class="loading"><b class="cur">●</b><b>●</b><b>●</b></span>');var loadList=[];function li(node){var intval=0;var intval=setInterval(function(){var cur=node.find('.cur');cur.removeClass('cur');if(!cur.next()[0]){return cur.parent().find(':first').addClass('cur');}
cur.next().addClass('cur');},500);this.stop=function(){if(intval)
clearInterval(intval);node.remove();}}
this.start=function(){loadList=[];for(var i=0,len=nodeList.length;i<len;i++){var n=html.clone();nodeList[i].html(n);loadList.push(new li(n));}}
this.stop=function(){for(var i=0,len=loadList.length;i<len;i++){loadList[i].stop();}}}
function bindEvent(){var baseTable=$('#hotel_base_info');(function(){var selectorDialog=baseTable.find('.selector_dialog');baseTable.on('click','.selectHandle',function(){if(selectorDialog.find('li').length<2)
return;selectorDialog.stop(true,false).slideToggle(260);});$(document).on('click',function(event){selectHandle=baseTable.find('.selectHandle');var event=event?event:window.event;var target=event.target||event.srcElement;if($(target).hasClass('selector_dialog')||$(target).parents().hasClass('selector_dialog')){return;}
if(target===selectHandle[0]||$('.selector_dialog:visible').length===0){return;}
selectHandle.trigger('click');});selectorDialog.on('click','li',function(){var $this=$(this);if($this.hasClass('selected'))
return;selectorDialog.find('.selected').removeClass('selected');$this.addClass('selected');var iNum=$(this).val();$('#houseNum option[value='+iNum+']').attr("selected","selected");$('#houseNum').trigger('change');selectorDialog.slideUp(500);});})();baseTable.on('change','#houseNum,.reachTime',function(){var param={roomNum:this.name!='roomNum'?self.roomNumEle.val():this.value,reachTime:this.name!='reachTime'?self.reachTimeEle.val():this.value};getRealtimeInfo(param,update);});}
function init(){if($('#bookOutTimeError')[0]||$('#minDaysError')[0]){self.setErrorStatus(true);return;}
if($("#user_islogin").val()>0){$("#promotionAll_tr").hide();$(".travel-coupon").removeClass('hide');$(".discount-coupon").removeClass('hide');}else{$("#promotionAll_tr").show();$(".travel-coupon").addClass('hide');$(".discount-coupon").addClass('hide');}
bindEvent();self.loadObj=new loading([$('#realPrice'),$('.submit_order .totalPrice'),$('#hotel_base_info .totalPrice')]);var param={};$('#houseNum').attr('param')>0?param['roomNum']=$('#houseNum').attr('param'):'';$('#hotel_base_info .reachTime').attr('param')>0?param['reachTime']=$('#hotel_base_info .reachTime').attr('param'):'';getRealtimeInfo(param,update);}
this.setErrorStatus=function(hideNormarlError){$('.cashBackBlock').hide();if(1==$('#cashbackInfo .order_table tr').length){$('#cashbackInfo').hide();}
$('#hotel_base_info .reachTime').attr('disabled',true);$('#hotel_base_info .guaranteeRule').hide();$('#realPrice,.totalPrice,.invoice_price').text('￥--');$('#g_next').hide();$('#g_empty').show();if(!hideNormarlError)
return $('#normalError').show();$('#normalError').hide();}
init();}
var hotelBook=new HotelBook();function loginAjax(){$("#user_islogin").val(1);$('.title_warn').remove();$('#extra_login_entry').hide();$("#cashBackRule").show();$("#promotionAll_tr").hide();init_hotel_favors();ajaxPromotion();ajaxPromotionCode();}
function ajaxPromotion(){var url='/order/promotion';var hotelPrdInfo={"cityCode":$("#bookCityCode").val(),"provinceCode":1,"countryCode":1,"productId":$('#productId').val(),"businessType":$('#businessType').val()};var params={"hotelPrdInfo":hotelPrdInfo};$.post(url,params,function(data){data=eval("("+data+")");$('#cashbackInfo .travel-coupon .column2').html($(data.prom));$('.travel-coupon').removeClass('hide');$("#travelCoupon_detail").html($(data.promDetail));});}
function ajaxPromotionRed(){var url='/yii.php?r=hotel/hotelOrder/promotionRed';var hotelPrdInfo={"cityCode":$("#bookCityCode").val(),"provinceCode":1,"countryCode":1,"productId":$('#productId').val(),"businessType":$('#businessType').val()};var params={"hotelPrdInfo":hotelPrdInfo};$.post(url,params,function(data){if(data!=0){$("#promotionRed_part").html($(data));$("#promotionRed_part").css("display","inline-block");$("#promotionRed_tr").css("display","table-row");initRed();}else{$("#promotionRed_tr").css("display","none");}});}
function ajaxPromotionCode(){var url='/yii.php?r=hotel/hotelOrder/promotionCode';var params={productId:$('#productId').val(),productLineId:$('#productLineId').val(),brandId:$('#brandId').val(),customerId:$('#customerId').val(),roomNum:$('#houseNum').val(),totalPrice:$('#totalPrice').val(),pValue:$('#pValue').val(),checkindate:$('#begin_date').val(),businessType:$('#businessType').val()};$.post(url,params,function(data){data=eval("("+data+")");renderPromotion(data.promotionCodeInfo);renderPrice();$('.discount-coupon').removeClass('hide');});}
function orderGuarantee(){$('#g_next').hide();$('.loading').show();$('#dyPop').nodelpop();$.ajax({url:'/order/orderguarantee',type:'post',dataType:'json',data:$('#form').serialize(),success:function(s){$('.loading').hide();$('#dyPop').hide();$('#divmask').remove();$('#g_next').show().attr('disabled',false);if(s.success){window.location.href='/order/success/'+s.orderId;return;}
else if(s.errorCode==133027){alert('信用卡信息填写有误，请重新填写。');}
else if(s.errorCode==133028){alert('对不起，订单已过期，不能进行担保。');window.location.href='http://www.tuniu.com/u/order';return;}
else{alert('系统正忙，请稍候重试。');}},error:function(e){alert('系统正忙，请稍候重试。');}});}
if($("#user_islogin").val()>0){init_hotel_favors();}
function init_hotel_favors(){if($("#mainland").val()>0){var d={type:1};}else{var d={type:2};}
$.post("/yii.php?r=hotel/hotelOrder/contacters",d,function(result){var data=eval("("+result+")");if(data){$.each(data,function(i,item){if($("#mainland").val()>0){var html="<a href='javascript:;'><i class='icon icon-square'></i><span>"+item+"</span></a>";}else{var html="<a href='javascript:;'><i class='icon icon-square'></i><span>"+item.lastname+" "+item.firstname+"</span></a>";}
$(".hotel_favors").append(html);});$(".hotel_favors").css("display","block");var hotel_favors=$(".hotel_favors");hotel_favors.find("a").each(function(i,n){if($(n)){$(n).click(function(){if($("#mainland").val()>0){autoCont(n);}else{autoContGa(n);}});}});init_favors();}});}
function autoContGa(n){var name=$(n).find("span").html();var $icon=$(n).children();if($icon.hasClass('selected')){$icon.removeClass('selected');var p=0;$('#rz_people input').each(function(i){var first_name=$("#rz_people input").eq(2*p).val();var last_name=$("#rz_people input").eq(2*p+1).val();var na=first_name+" "+last_name;if(na==name){$("#rz_people input").eq(2*p).val("");$("#rz_people input").eq(2*p+1).val("");$("#rz_people input").eq(2*p).addClass('grey');$("#rz_people input").eq(2*p+1).addClass('grey');}
p++;});}else{var flag=false;var q=0;var str=name.split(" ");var first=str[0];var last=str[1];$('#rz_people input').each(function(i,o){var first_name=$("#rz_people input").eq(2*q).val();var last_name=$("#rz_people input").eq(2*q+1).val();if(first_name==''||last_name==''||first_name==this.defaultValue||last_name==this.defaultValue){flag=true;$("#rz_people input").eq(2*q).val(first);$("#rz_people input").eq(2*q+1).val(last);hotel_check.check_name(o,"#rz_name_tip");$("#rz_people input").eq(2*q).removeClass('grey');$("#rz_people input").eq(2*q+1).removeClass('grey');$icon.addClass('selected');return false;}
q++;});if(flag==false){alert("一房间最多可选择一人，可增加房间数");}}}
function autoCont(n){var name=$(n).find("span").html();var $icon=$(n).children();if($icon.hasClass('selected')){$icon.removeClass('selected');$('#rz_people input').each(function(i){var input_val=$("#rz_people input").eq(i).val();if(input_val==name){$("#rz_people input").eq(i).val(this.defaultValue);$("#rz_people input").eq(i).addClass('grey');}});}else{var flag=false;$('#rz_people input').each(function(i,o){var input_val=$("#rz_people input").eq(i).val();if(input_val==''||input_val==this.defaultValue){flag=true;$("#rz_people input").eq(i).val(name);hotel_check.check_name(o,"#rz_name_tip");$("#rz_people input").eq(i).removeClass('grey');$icon.addClass('selected');return false;}});if(flag==false){alert("一房间最多可选择一人，可增加房间数");}}}
function init_favors(){var hotel_favors=$(".hotel_favors");hotel_favors.find("a").each(function(o,p){if($(p)){$("#rz_people").find("input").each(function(i,n){if($(n)){var name=$(n).val();if(name!=''&&name!=this.defaultValue){var $icon=$(p).children();var comm_name=$(p).find("span").html();$icon.removeClass('selected');if(comm_name==name){$icon.addClass('selected');$(n).removeClass('grey');return false;}}}});}});}
function renderPromotion(data){if(!(data.ordinary.length+data.special.length+data.invincible.length)){$('#cashbackInfo .discount-coupon .row').html(template('no-discount-coupon-template',{}));}else{$('#cashbackInfo .discount-coupon .row').html('<div class="a1"><div class="clear-box"></div><span class="price"></span><div class="d"><a href="javascript:addPromotionCode();">添加优惠券</a></div></div><div class="coupon-list"></div>');$('.discount-coupon').removeClass('hide');var html=template('discount-coupon-template',data);var $couponList=$('#cashbackInfo .coupon-list');$couponList.html(html);var $showMoreInvincible=$couponList.find('.showMoreActiveInfo.invincible'),$hideSomeInvincible=$couponList.find('.hideSomeActiveInfo.invincible');$showMoreInvincible.on('click',function(){$(this).addClass('hide');$hideSomeInvincible.removeClass('hide');$couponList.find('.item.invincible.hide').each(function(){$(this).show();});if($('#cashbackInfo .order_con').css('visibility')=='visible'){$('#cashbackInfo .order_con').css({'visibility':'inherit'});}else{$('#cashbackInfo .order_con').css({'visibility':'visible'});}});$hideSomeInvincible.on('click',function(){$(this).addClass('hide');$showMoreInvincible.removeClass('hide');$couponList.find('.item.invincible').each(function(i,e){if(i>0)$(e).hide();});if($('#cashbackInfo .order_con').css('visibility')=='visible'){$('#cashbackInfo .order_con').css({'visibility':'inherit'});}else{$('#cashbackInfo .order_con').css({'visibility':'visible'});}});var $showMoreActiveInfo=$couponList.find('.showMoreActiveInfo.ordinary'),$hideSomeActiveInfo=$couponList.find('.hideSomeActiveInfo.ordinary');$showMoreActiveInfo.on('click',function(){$(this).addClass('hide');$hideSomeActiveInfo.removeClass('hide');$couponList.find('.item.ordinary.hide').each(function(){$(this).show();});if($('#cashbackInfo .order_con').css('visibility')=='visible'){$('#cashbackInfo .order_con').css({'visibility':'inherit'});}else{$('#cashbackInfo .order_con').css({'visibility':'visible'});}});$hideSomeActiveInfo.on('click',function(){$(this).addClass('hide');$showMoreActiveInfo.removeClass('hide');$couponList.find('.item.ordinary').each(function(i,e){if(i>0)$(e).hide();});if($('#cashbackInfo .order_con').css('visibility')=='visible'){$('#cashbackInfo .order_con').css({'visibility':'inherit'});}else{$('#cashbackInfo .order_con').css({'visibility':'visible'});}});$('#cashbackInfo .coupon-list .item').each(function(index,element){$(element).find('.d').on('click',function(){var trigger=$(this).find('a');$(element).find('.description').toggle();if(trigger.hasClass('showMore')){trigger.removeClass('showMore').addClass('hideMore');}else{trigger.removeClass('hideMore').addClass('showMore');}
if($('#cashbackInfo .order_con').css('visibility')=='visible'){$('#cashbackInfo .order_con').css({'visibility':'inherit'});}else{$('#cashbackInfo .order_con').css({'visibility':'visible'});}});});$('#cashbackInfo .coupon-list').on('click','.box',function(e){var $this=$(this);var $invincibleBoxes=$('#cashbackInfo .coupon-list .invincible.box');var $otherBoxes=$('#cashbackInfo .coupon-list .ordinary.box, #cashbackInfo .coupon-list .special.box');if($this.hasClass('invincible')){if($this.hasClass('box-selected')){$this.removeClass('box-selected');}else{$invincibleBoxes.each(function(){if($(this).hasClass('box-selected'))$(this).removeClass('box-selected');});$this.addClass('box-selected');}}else{if($this.hasClass('box-selected')){$this.removeClass('box-selected');}else{$otherBoxes.each(function(){if($(this).hasClass('box-selected'))$(this).removeClass('box-selected');});$this.addClass('box-selected');}}
renderPrice(true);});}};function getPromotionValue(){var promotionContain=$('#cashbackInfo .discount-coupon .coupon-list .box-selected');var result=0;var ipromotion=0;var iprompt=0;if(promotionContain.length){promotionContain.each(function(){var tmp=parseInt($(this).data('price'));result+=tmp;if(parseInt($(this).data('type'))===14){iprompt+=tmp;}
if(parseInt($(this).data('type'))===21){ipromotion+=tmp;}});}
return{result:result,ipromotion:ipromotion,iprompt:iprompt};};function renderPrice(isPromotion){$('#g_next').show();var totalPrice=hotel_order.formatFloat($('#totalPrice').val());var promotion=getPromotionValue();var iRed=0;var iTravel=hotel_order.formatFloat($('#use_price').val());var cashback=hotel_order.formatInt($('#cashBacked').val())*hotel_order.formatInt($('#houseNum').val());if(cashback){$('.cash-back').show();$('.cash-back .price').html('￥'+cashback.toFixed(0));}else{$('.cash-back').hide();}
if($('#businessType').val()==3){if(totalPrice<promotion.result+iRed+iTravel){var tmp=promotion.result+iRed+iTravel-totalPrice;if(iTravel>tmp){iTravel=iTravel-tmp;$('#use_price').val(iTravel);}else{layer.alert('优惠券用不了。');}}
var tip='<div class="big-up-arrow"></div><div class="small-up-arrow"></div>';if(iRed)tip+='<span>酒店红包￥'+iRed+'</span><br>';if(iTravel)tip+='<span>旅游券已减￥'+iTravel+'</span><br>';if(promotion.ipromotion)tip+='<span>优惠券已减￥'+promotion.ipromotion+'</span><br>';if(promotion.iprompt)tip+='<span>立减活动已减￥'+promotion.iprompt+'</span><br>';if(iTravel+iRed+promotion.result){$('.promotionTip .promotionTotal span').text(iTravel+iRed+promotion.result);$('.promotionTip .tip').html(tip);$('.promotionTip').css({display:'inline-block'});}else{$('.promotionTip').hide();}
$('#realPrice,.totalPrice').add($('.invoice_price')).html('￥'+parseFloat(totalPrice-iTravel-promotion.result-iRed).toFixed(2));if(iTravel){$('.travelCoupons_cut').text('￥'+iTravel);}else{$('.travelCoupons_cut').text('');}}else{if(isPromotion){if(promotion.result+iTravel+iRed+cashback>totalPrice){var tmp=promotion.result+iRed+iTravel+cashback-totalPrice;if(iTravel>tmp){iTravel=iTravel-tmp;$('#use_price').val(iTravel);}else{layer.alert('优惠券用不了。');}}}
$('#realPrice,.totalPrice').add($('.invoice_price')).html('￥'+parseFloat(totalPrice).toFixed(2));if(iTravel){$('.travelCoupons_cut').text('￥'+iTravel);}else{$('.travelCoupons_cut').text('');}
cashback+=promotion.result+iTravel+iRed;$('#cashBackTotal, .cashBackTotal').html('￥'+cashback.toFixed(2));var expression='￥'+cashback+"=￥"+formatInt($('#cashBacked').val())+"×"+formatInt($('#houseNum').val())+"+"+"￥"+iTravel+"+"+"￥"+promotion.result+"+"+"￥"+iRed;$("#cashbackExpression").html(expression);}
if(promotion.result){$('#cashbackInfo .discount-coupon .a1 .price').text('￥'+promotion.result);}else{$('#cashbackInfo .discount-coupon .a1 .price').text('');}
if(cashback){$('.cashBackBlock, .cashback').show();$('#cashBackTotal, .cashBackTotal').html('￥'+cashback.toFixed(2));}else{$('.cashBackBlock, .cashback').hide();$('#cashBackTotal, .cashBackTotal').html('￥00.00');}};function redUpdate(){$(".nored").css("display","none");renderPrice();}
if($('#businessType').val()!='3'){$(document).delegate('.redspan','mouseover',function(){var id=this.getAttribute("id");var classname=id.replace("red","tips");$("."+classname).css("display","inline-block");});$(document).delegate('.redspan','mouseout',function(){var id=this.getAttribute("id");var classname=id.replace("red","tips");$("."+classname).css("display","none");});}
(function(){var top=153;$(window).on('scroll',function(){var left=parseFloat($('#main').offset().left)+parseFloat($('#main').width())+16;if($(document).scrollTop()>=top){$('#aside').css({'position':'fixed','top':'0','left':left});}else{$('#aside').css({'position':'static'});}});})();$(window).on('resize',function(){if($('#aside').css('position')=='fixed'){var left=parseFloat($('#main').offset().left)+parseFloat($('#main').width())+16;$('#aside').css({'left':left});}});;var order_perfect={schemeMust:false,promoIndex:-1,show_help:function(obj){var left=this.findPosX(obj)-18;var top=this.findPosY(obj)+18;$("#tips_box").css('left',left);$("#tips_box").css('top',top);var show_travel_coupon_help_flag=$("#show_travel_coupon_help_flag").val();var group_cost=parseInt($("#group_cost").val());if(show_travel_coupon_help_flag==1&&group_cost==0){$("#tips_box_inner").html('<h3>使用规则说明</h3><p>填写额度不得超出当前使用金额，为小于或等于当前使用金额的整数。</p>');}else{$("#tips_box_inner").html('<h3>使用规则说明</h3><p>可使用全部余额，也可使用部分余额，填写额度为小于或等于当前余额的整数。</p>');}
$("#tips_box").show();},hidden_help:function(){$("#tips_box").hide();},userGet:function(){var user_num=this.formatInt($("#user_num").val());var children_num=this.formatInt($("#children_num").val());return{'user_num':user_num,'children_num':children_num}},additionPrice:function(){var budget=this.formatInt($("#budget").val());var children_budget=this.formatInt($("#children_budget").val());var person_num=this.userGet();user_num=person_num.user_num;children_num=person_num.children_num;var room_add_budget=this.formatInt($("#room_add_budget").val());var dfc_flag=this.formatInt($("#dan_fang_cha").val());try{var flag=document.getElementById("dfc_radio_1").checked;if(flag==false){if(document.getElementById("dfc_radio_6")!=null){flag=document.getElementById("dfc_radio_6").checked;}}}catch(e){}
if(flag==false||dfc_flag==0){room_add_budget=0;}
var scheme_price=this.formatInt($("#scheme_price").val());var visa_scheme_price=this.getVisaSchemeTotalSum();var insurance_price=this.getInsuranceTotalSum();this.setInsurance();var self_charge_price=this.getSelfChargeTotalSum();this.setSelfCharge();var user_pay=budget*user_num;var children_pay=children_num*children_budget;var attach_pay=0;var attach_ele=document.getElementById("attach_price_hid");if(attach_ele&&attach_ele.value!==""){attach_pay=parseInt(attach_ele.value);}
var additionCost=user_pay+children_pay+room_add_budget+scheme_price+insurance_price+self_charge_price+visa_scheme_price+attach_pay;return additionCost;},substructionPrice:function(){var coupon_cut=this.formatInt($("#change_coupon").val());var travel_coupon_cut=-this.formatInt($("#travel_coupon_cut").val());this.setPromoAmount();var promoAmount=this.formatInt($("#hidPromoAmount").val());var promoExCoupon=$("#hidPromoExCoupon").val();if((promoExCoupon&1)==1){coupon_cut=0;}
if(coupon_cut==0){$("#coupon_summary").hide();}else{$("#coupon_summary").show();}
if((promoExCoupon&2)==2){travel_coupon_cut=0;}
var substructionCost=coupon_cut+promoAmount+travel_coupon_cut;var promotion_offset=this.formatInt($("#promotion_offset").val());if(promotion_offset){substructionCost=promotion_offset+travel_coupon_cut;}
return substructionCost;},changePrice:function(){var additionCost=this.additionPrice();var substructionCost=this.substructionPrice();var money=additionCost-substructionCost;var insurancePrice=this.getInsuranceTotalSum();var invoiceTotal=money-insurancePrice;if(invoiceTotal<=0){invoiceTotal=0;insurancePrice=0;}
if(money<0){this.giveBackTravelCoupon(-money);money=0;}
if(money<=0){$("#use_button").attr("disabled",true);}
$("#total_cost").val(additionCost);$("#group_cost").val(money);$("#invoice_total").html('¥'+invoiceTotal);$("#invoice_amount_f").attr("value",invoiceTotal);$("#invoice_insurace").html('¥'+insurancePrice);$("#invoice_insurance_price_f").attr("value",insurancePrice);$("#group_cost_show").html('¥'+money);var total_cost=$("#total_cost").val();$(".price_subtract_min_line").each(function(){var price_subtract_min_line=$(this).val();var key=$(this).attr('name');var pri_sub=$('.price_sub_key_'+key);if(parseFloat(total_cost)>parseFloat(price_subtract_min_line)){pri_sub.find('input[type="radio"]').removeAttr('disabled');pri_sub.find('.price_sub_amount').css('display','block');pri_sub.find('.price_sub_amount_no').css('display','none');}else{pri_sub.find('input[type="radio"]').attr('disabled',true);pri_sub.find('.price_sub_amount_no').css('display','block');pri_sub.find('.price_sub_amount').css('display','none');}});},updateScheme:function(scid,room_add_budget){$("#routes_scheme_id").val(scid);var budget_child=this.formatInt($("#sc_budget_child_"+scid).val());var budget=this.formatInt($("#sc_budget_"+scid).val());var person_num=this.userGet();user_num=person_num.user_num;children_num=person_num.children_num;adult_price=user_num*budget;child_price=children_num*budget_child;var total_price=this.formatInt(adult_price+child_price);$("#scheme_price").val(total_price);this.setDfcSc(room_add_budget);this.changePrice();if(scid>0){var scheme_name=$("#scheme_name_"+scid).html();var summary_html='<hr /><div class="part"><p class="part_name">升级方案</p><p>'+scheme_name+'</p>';if(adult_price>0){summary_html+='<p class="pn"><span class="pn_1">'+user_num+'成人 × ¥'+budget+'</span><span class="pn_2">¥'+adult_price+'</span></p>';}
if(child_price>0){summary_html+='<p class="pn"><span class="pn_1">'+children_num+'儿童 × ¥'+budget_child+'</span><span class="pn_2">¥'+child_price+'</span></p>';}
summary_html+='</div>';$("#scheme_summary").html(summary_html);$("#scheme_summary").show();}else{$("#scheme_summary").hide();}},formatInt:function(num){num=parseInt(num);num=isNaN(num)?0:num;return num;},checkCoupon:function(){$("#check_coupon_show").html('');var coupon_id=$("#coupon_id").val();var pars="main.php?do=order_perfect_ajax&flag=1&coupon_id="+coupon_id;var reg=/^[0-9]+$/gi;if(!coupon_id.match(reg)){$("#check_coupon_show").html('抵用券不正确');return false;}
coupon_ids=$("#coupon_ids").val();e_coupon_id=coupon_ids.split(",");for(i=0;i<e_coupon_id.length;i++){if(e_coupon_id[i]==coupon_id){$("#check_coupon_show").html('此抵用券已在本订单中使用');return false;}}
$.get(pars,function(data){msg=''
if(parseInt(data)>0&&parseInt(data)==data){msg='OK';add_coupon=parseInt($("#add_coupon").val());if(isNaN(add_coupon)){add_coupon=0;}
$("#add_coupon").val(parseInt(data)+add_coupon);var coupon_ids=$("#coupon_ids").val();coupon_ids=coupon_ids+','+coupon_id;$("#coupon_ids").val(coupon_ids);order_perfect.couponTotal();order_perfect.changePrice();order_perfect.couponBoxRemove();}else{switch(data){case'-1':msg='抵用券错误';break;case'-2':msg='抵用券已经被使用';break;case'-3':msg='没有此抵用券';break;case'-4':msg='抵用券已经过期';break;default:msg='无法使用，系统错误';}
$("#check_coupon_show").html(msg);}})},couponTotal:function(){var left_coupon=parseInt($("#left_coupon").val());var left_coupon=isNaN(parseInt(left_coupon))?0:parseInt(left_coupon);var add_coupon=parseInt($("#add_coupon").val());var add_coupon=isNaN(parseInt(add_coupon))?0:parseInt(add_coupon);var coupon=left_coupon+add_coupon;var max_coupon=parseInt($("#max_coupon").val());var user_num=parseInt($("#user_num").val());var max_use_coupon=user_num*max_coupon;var coupon_cut=coupon>max_use_coupon?max_use_coupon:coupon;$("#coupon_left").html(coupon);$("#coupon_cut").html('-'+coupon_cut);$("#change_coupon").val(coupon_cut);},giveBackTravelCoupon:function(back_money){order_perfect.giveBackUserTravelCoupon(back_money);},giveBackUserTravelCoupon:function(back_money){back_money=parseInt(back_money);var use_price=parseInt($("#use_price").val());var use_price_begin=parseInt($("#use_price_begin").val());var travel_coupon_cut=parseInt($("#travel_coupon_cut").val());var group_cost=parseInt($("#group_cost").val());var new_use_price=use_price-back_money;if(new_use_price>=0){$("#use_price").val(new_use_price);$("#use_price_begin").val(use_price_begin-back_money);$("#travel_coupon_cut").val(travel_coupon_cut+back_money);$("#travel_coupon_cut_show").html('- ¥'+new_use_price);}else{$("#use_price").val(0);$("#use_price_begin").val(0);$("#travel_coupon_cut").val(-0);$("#group_cost").val(group_cost-travel_coupon_cut);$("#group_cost").html(group_cost-travel_coupon_cut);$("#travel_coupon_cut_show").hide();}},rechageTravelCoupon:function(){$("#check_travel_coupon_show").html('');var group_cost_show=parseInt($("#group_cost").val());if(group_cost_show<=0){$("#check_travel_coupon_show").html('总价已为0，不必使用旅游券');$("#check_travel_coupon_show").show();return;}
var travel_coupon_id=$("#travel_coupon_id").val();if(travel_coupon_id==''){$("#check_travel_coupon_show").html('请输入旅游券编号');$("#check_travel_coupon_show").show();return;}
var travel_coupon_password=$("#travel_coupon_password").val();if(travel_coupon_password==''){$("#check_travel_coupon_show").html('请输入旅游券密码');$("#check_travel_coupon_show").show();return;}
$("#check_travel_coupon_show").hide();var travel_coupon_cut=$("#travel_coupon_cut").val();travel_coupon_id=travel_coupon_id.replace(/^\s+|\s+$/g,"");travel_coupon_password=travel_coupon_password.replace(/^\s+|\s+$/g,"");var url="/main.php?do=user_travel_coupon";$.post(url,{act:'re_charge',flag:'add',coupon:travel_coupon_id,password:travel_coupon_password},function(data){if(data==-4){$("#check_travel_coupon_show").html('旅游券已充值到其他用户，请核查');return false;}else if(data==-2){$("#check_travel_coupon_show").html('使用失败');return false;}else if(data==-1){$("#check_travel_coupon_show").html('用户名或密码不对，请填写正确密码');return false;}else if(data==-3){$("#check_travel_coupon_show").html('该旅游券已充值在贵账号下，请直接使用');return false;}else if(data==-5){$("#check_travel_coupon_show").html('旅游券已完全使用，不可充值');return false;}else if(data==-6){$("#check_travel_coupon_show").html('用户未绑定手机号');return false;}else if(data==-11){$("#check_travel_coupon_show").html('用户名或密码输入错误超过3次，请10分钟后重试');return false;}else if(data==0){$("#check_travel_coupon_show").html('使用失败');return false;}else if(data>0){data=order_perfect.formatInt(data);var group_cost_show=order_perfect.formatInt($("#totalPrice").val());var travel_left_coupon=order_perfect.formatInt($("#travel_left_coupon").val());travel_left_coupon=travel_left_coupon+data;$("#travel_left_coupon").val(travel_left_coupon);$("#promotion_part .dy_tip").html('旅游券余额'+travel_left_coupon+'元');if(group_cost_show<=0){$("#check_travel_coupon_show").html('充值成功，总价已为0，不必使用旅游券');}else{var use_price=order_perfect.formatInt($("#use_price").val());var use_price_begin=order_perfect.formatInt($("#use_price_begin").val());if(data>group_cost_show){$('#travel_coupon_cut').val(travel_coupon_cut-group_cost_show);$("#use_button").attr("disabled","true");$("#btn_travel_coupon_use_other").css("display","none");$("#check_travel_coupon_use_success_show").html('旅游券金额('+data+'元)<br />已使用金额：'+group_cost_show
+'元，计入小计金中<br />余额：'+(data-group_cost_show)+'元，可以下次出游时使用');}else{$('#travel_coupon_cut').val(travel_coupon_cut-data);$("#use_button").removeAttr("disabled");$("#btn_travel_coupon_use_other").css("display","inline");$("#check_travel_coupon_use_success_show").html('旅游券金额('+data+'元)已计入小计金额中');}
$("#use_price_begin").val($("#use_price").val());order_perfect.travelCouponBoxRemove();order_perfect.travelCouponUseSuccessBoxShow();}
return false;}});},checkTravelCoupon:function(){var travel_coupon_use=$('#use_price').val();var flag=true;if(travel_coupon_use>0){var url='/main.php?do=order_fill_check_coupon';$.ajax({type:'POST',url:url,data:{'flag':'check_mark_active'},dataType:'json',async:false,success:function(data){if(data==-1){alert('您已使用旅游券，但未成功验证，请确认后进入下一步');var use_price=get_use_price();$('#use_coupon_price_change').val(use_price);showdypop();flag=false;}else{var use_price=get_use_price();if(use_price<0){$("#travel_coupon_summary").hide();alert('请输入正确的旅游券金额');flag=false;}else if(use_price>0&&$("#travel_coupon_summary").css('display')=='none'){$('#use_price').val(use_price);$("#travel_coupon_cut_show").html('- ¥'+use_price);$("#travel_coupon_summary").show();chagePriceByTravelCoupon(use_price);}}}});}
return flag;},checkSubmit:function(){if(!this.checkTravelCoupon()){return false;}
if($("#arrive_time:visible").length>0){if(!this.check_arrive_time()){return false;}}
if($("#arrive_flight:visible").length>0){if(!this.check_arrive_flight()){return false;}}
if($("#leave_time:visible").length>0){if(!this.check_leave_time()){return false;}}
if($("#leave_flight:visible").length>0){if(!this.check_leave_flight()){return false;}}
var new_login_val=$("#new_login_t").css("display");var new_login_exist=$("#new_login_t").length;if(new_login_exist>0){if(new_login_val=='none;'||new_login_val=='none'){}else{var new_login_flag=$("#new_login:checked").length;if(new_login_flag==0){$('#login_tip').text('请阅读会员协议').show();return false;}}}
var old_login_exist=$("#old_login_t").length;var old_login_val=$("#old_login_t").css("display");if(old_login_exist>0){if(old_login_val=='none'||old_login_val=='none;'){}else{$('#login_tip').text('请先登录').show();return false;}}
var group_cost=order_perfect.formatInt($("#group_cost").val());if(group_cost<0){alert("总价必须大于0");return false;}
order_perfect.setInsurance();if(!order_perfect.checkPromotion()){return false;}
var val=$('input:radio[name="check_fapiao"]:checked').val();if(val=='yes'){if($("#invoice_amount_f").val()==0||$("#invoice_amount_f").val()==-1){$("#need_invoice").attr("value","no");}else{if(this.check_invoice_title()==false)
return false;if($("#moreAddr").is(":hidden")){var check=typeof($('input:radio[name="dialog_addr"]:checked').val());if("undefined"==check){$("#invoice_title_notice").show();$("#invoice_title_notice span i").html('请选择配送地址');location.hash='#invoice_title_notice';return false;}else{$("#invoice_radio_f").attr("value",$("input[name='dialog_addr']:checked").val());$("#invoice_title_notice").hide();$("#invoice_title_notice span i").html('');}}else{if(this.check_invoice_people()==false)
return false;if(this.check_invoice_code()==false)
return false;if(this.check_invoice_address()==false)
return false;if(this.check_invoice_tel()==false)
return false;if(this.check_invoice_phone()==false)
return false;$("#invoice_radio_f").attr("value",0);$("#invoice_name_f").attr("value",$("#invoice_name").val());$("#invoice_tel_f").attr("value",$("#invoice_tel").val());$("#invoice_phone_f").attr("value",$("#invoice_phone1").val()+"-"+$("#invoice_phone2").val());var province=$("#province option:selected").text().split('_');var city=$("#city option:selected").text().split('_');$("#invoice_province_f").attr("value",province[0]);$("#invoice_city_f").attr("value",city[0]);$("#invoice_address_f").attr("value",$("#invoice_address").val());$("#invoice_code_f").attr("value",$("#invoice_code").val());}
$("#invoice_title_f").attr("value",$("#invoice_title").val());$("#need_invoice").attr("value","yes");}}else{$("#invoice_amount_f").attr("value",-1);}
if($('#travel_coupon_check').attr('checked')==false){$('#use_price').val(0);}
if($('#coupon_summary').css('display')=='none'){$('#change_coupon').val(0);}
$("#frm_submit").submit();},setDfcSc:function(room_add_budget){$("#room_add_budget_show1").html('¥'+room_add_budget);$("#room_add_budget_show_1").html('¥'+room_add_budget);var user_num=this.formatInt($("#user_num").val());var dfc_num=this.formatInt($("#dfc_num").val());if(room_add_budget>0&&user_num%2==1){$("#dan_fang_cha").val(1);$("#dfc_tb").show();}
room_add_budget=dfc_num*room_add_budget;var flag=$("#dfc_radio_1").attr("checked");if(flag==false){flag=$("#dfc_radio_6").attr("checked");}
if(flag==true){$("#room_add_budget_show2").html('¥'+room_add_budget);$("#dfc_summary").show();}
$("#room_add_budget").val(room_add_budget);},checkDfcFlag:function(){var dfc=$("#room_add_budget").val();var dfc_num=this.formatInt($("#dfc_num").val());if(dfc_num>0&&dfc>0){$("#dan_fang_cha").val(1);$("#dfc_tb").show();}else{$("#dan_fang_cha").val(0);$("#dfc_tb").hide();}},couponBoxRemove:function(){$("#coupon_box").attr('class','hidden');},couponBoxShow:function(){$("#travel_coupon_box").attr('class','hidden');order_perfect.travelCouponUseSuccessBoxRemove();if($("#is_login").length>0){var obj=document.getElementById("add_button");var left=this.findPosX(obj);var top=this.findPosY(obj);$("#coupon_box").css('left',left);$("#coupon_box").css('top',top);$("#coupon_box").attr('class','');}},travelCouponBoxRemove:function(){$("#travel_coupon_box").attr('class','hidden');},travelCouponBoxShow:function(){$.layer({type:1,fix:false,title:false,border:[2,0.3,'#DDD'],shade:[0.5,'#000'],area:['410px','240px'],page:{dom:'#travel_coupon_box'}});},travelCouponUseSuccessBoxRemove:function(){$("#travel_coupon_use_success_box").attr('class','hidden');},travelCouponUseSuccessBoxShow:function(){$("#coupon_box").attr('class','hidden');var obj=document.getElementById("use_button");var left=this.findPosX(obj);var top=this.findPosY(obj);$("#travel_coupon_use_success_box").css('left',left);$("#travel_coupon_use_success_box").css('top',top);$("#travel_coupon_use_success_box").attr('class','');},travelCouponDetailBoxShow:function(e){$.layer({type:1,fix:false,title:false,border:[0],border:[2,0.3,'#DDD'],shade:[0.5,'#000'],area:['630px','auto'],offset:['200px',''],page:{dom:'#travelCoupon_detail'}});},radioChange:function(){var flag=document.getElementById("dfc_radio_1").checked;if(flag==false){if(document.getElementById("dfc_radio_6")!=null){var flag=document.getElementById("dfc_radio_6").checked;}}
var add_budget=this.formatInt($("#room_add_budget").val());if(flag==false){$("#dfc_summary").hide();}else{$("#room_add_budget_show2").html("¥"+add_budget);$("#dfc_summary").show();}
this.changePrice();},chooseInsurance:function(i){if($("#insurance_num_"+i).attr("checked")==true){$(".addleft_spacing").hide();}else{var mark=0;var insurance_cnt=this.formatInt($("#insurance_cnt").val());for(var j=1;j<=insurance_cnt;j++){if($("#insurance_num_"+j).attr("checked")==true){mark=1;break;}}
if(mark==0){$(".addleft_spacing").show();}}
this.setInsurance();this.changePrice();},getVisaSchemeTotalSum:function(){var visa_length=$('input[id^="visa_name"]').length;var total_sum=0;for(i=1;i<=visa_length;i++){if($('#visa_checkbox_'+i+':checked').length){var price=this.formatInt($("#visa_price_"+i).val());var visa_num=$('#share_'+i).val();total_sum+=visa_num*price;}}
return total_sum;},getInsuranceTotalSum:function(){var count=this.formatInt($("#insurance_count").val());var total_sum=0;var user_num=this.formatInt($("#user_num").val());var children_num=this.formatInt($("#children_num").val());var total_num=user_num+children_num;for(var i=1;i<=count;i++){if($("#insurance_num_"+i).attr('checked')==true){var price=this.formatInt($("#insurance_num_price_"+i).val());total_sum+=price*total_num;}}
return total_sum;},setInsurance:function(){var count=this.formatInt($("#insurance_count").val());var insurance_content='';var insurance_no=0;var insurance_price=0;var sum_price=0;var user_num=this.formatInt($("#user_num").val());var children_num=this.formatInt($("#children_num").val());var total_num=user_num+children_num;var summary_html='<hr /><div class="part"><p class="part_name">保险费用</p>';for(var i=1;i<=count;i++){insurance_no=this.formatInt($("#insurance_num_"+i).val());insurance_num=this.formatInt($("#insurance_num_slt_"+i).val());insurance_price=this.formatInt($("#insurance_num_price_"+i).val());insurance_name=$("#insurance_num_name_"+i).val();if($("#insurance_num_"+i).attr('checked')==true){insurance_content+=insurance_no+','+total_num+','+insurance_price+';';sum_price=total_num*insurance_price;summary_html+='<p>'+insurance_name+'</p>'+'<p class="pn">';if(sum_price){summary_html+='<span class="pn_1">'+total_num+'份 × ¥'+insurance_price+'</span><span class="pn_2">¥'+sum_price+'</span>';}else{summary_html+='<span class="pn_1">&nbsp;</span><span class="pn_2">赠送</span>'}}}
summary_html+='</div>';if(insurance_content!=''){$("#insurance_summary").html(summary_html);$("#insurance_summary").show();}else{$("#insurance_summary").hide();}
$("#insurance_content").val(insurance_content);},chooseSelfCharge:function(i){if($("#self_charge_"+i).attr('checked')==true){$("#self_charge_num_slt_"+i).removeAttr('disabled');}else{$("#self_charge_num_slt_"+i).attr('disabled',true);}
this.setSelfCharge();this.changePrice();},changeSelfCharge:function(i){var num=this.formatInt($("#self_charge_num_slt_"+i).val());var price=this.formatInt($("#self_charge_price_"+i).val());var sum_price=price*num;$("#self_charge_sum_int_"+i).val(sum_price);this.setSelfCharge();this.changePrice();},getSelfChargeTotalSum:function(){var count=this.formatInt($("#self_charge_count").val());var total_sum=0;for(var i=0;i<count;i++){if($("#self_charge_"+i).attr('checked')==true){total_sum+=this.formatInt($("#self_charge_sum_int_"+i).val());}}
return total_sum;},setSelfCharge:function(){var count=this.formatInt($("#self_charge_count").val());var self_charge_content='';var self_charge_name='';var self_charge_num=0;var self_charge_price=0;var flag=0;var summary_html='<hr /><div class="part"><p class="part_name">自费项目</p>';for(var i=0;i<count;i++){self_charge_name=$("#self_charge_name_"+i).val();self_charge_num=this.formatInt($("#self_charge_num_slt_"+i).val());self_charge_price=this.formatInt($("#self_charge_price_"+i).val());self_charge_sum=self_charge_price*self_charge_num;if(self_charge_num!=0&&$("#self_charge_"+i).attr("checked")==true){self_charge_content+=self_charge_name+','+self_charge_num+','+self_charge_price+';';summary_html+='<p>'+self_charge_name+'</p><p class="pn"><span class="pn_1">'+self_charge_num+'份 × ¥'+self_charge_price+'</span><span class="pn_2">¥'+self_charge_sum+'</span></p>';flag=1;}}
summary_html+='</div>';if(flag>0){$("#self_summary").html(summary_html);$("#self_summary").show();}else{$("#self_summary").hide();}
$("#self_charge_content").val(self_charge_content);},findPosX:function(obj){var curleft=0;if(obj&&obj.offsetParent){while(obj.offsetParent){curleft+=obj.offsetLeft;obj=obj.offsetParent;}}else if(obj&&obj.x)curleft+=obj.x;return curleft;},findPosY:function(obj){var curtop=0;if(obj&&obj.offsetParent){while(obj.offsetParent){curtop+=obj.offsetTop;obj=obj.offsetParent;}}else if(obj&&obj.y)curtop+=obj.y;return curtop;},getElementsByClass:function(searchClass,node,tag){var classElements=new Array();if(node==null){node=document;}
if(tag==null){tag='*';}
var els=node.getElementsByTagName(tag);var elsLen=els.length;var pattern=new RegExp("(^|\\s)"+searchClass+"(\\s|$)");for(i=0,j=0;i<elsLen;i++){if(pattern.test(els[i].className)){classElements[j]=els[i];j++;}}
return classElements;},change_flight:function(){var ftables=this.getElementsByClass("flight_table",null,"table");ftables[0].style.display="none";ftables[1].style.display="";return false;},sltTicket:function(ticket_id){var all_ticket_id=$("#all_ticket_id").val();var ticket_arr=all_ticket_id.split(",");var user_price=this.formatInt($("#ticket_price_"+ticket_id).val());var children_price=this.formatInt($("#children_ticket_price_"+ticket_id).val());var leng=ticket_arr.length;var diff_adult_price=0;var diff_child_price=0;var person_num=this.userGet();for(var i=0;i<leng;i++){user_price2=$("#ticket_price_"+ticket_arr[i]).val();children_price2=$("#children_ticket_price_"+ticket_arr[i]).val();diff_adult_price=this.formatInt(user_price2)-user_price;diff_child_price=this.formatInt(children_price2)-children_price;diff_price=diff_adult_price*person_num.user_num+diff_child_price*person_num.children_num;diff_price=diff_price==0?'':diff_price;$("#diff_price_"+ticket_arr[i]).html(diff_price);}
var default_ticket_id=$("#default_ticket_id").val();if(default_ticket_id==ticket_id){$("#ticket_summary").hide();}else{var default_user_price=this.formatInt($("#ticket_price_"+default_ticket_id).val());var default_children_price=this.formatInt($("#children_ticket_price_"+default_ticket_id).val());diff_adult_price=user_price-default_user_price;diff_child_price=children_price-default_children_price;diff_adult_price_sum=diff_adult_price*person_num.user_num;diff_children_price_sum=diff_child_price*person_num.children_num;if(diff_adult_price_sum!=0||diff_children_price_sum!=0){var summary_html='<hr /><div class="part"><p class="part_name">机票升级费</p>';if(diff_adult_price_sum!=0){if(diff_adult_price_sum>0){summary_html+='<p class="pn"><span class="pn_1">'+person_num.user_num+'成人 × ¥'+diff_adult_price+'</span><span class="pn_2">¥'+diff_adult_price_sum+'</span></p>';}else{summary_html+='<p class="pn"><span class="pn_1">'+person_num.user_num+'成人 × - ¥'+Math.abs(diff_adult_price)+'</span><span class="pn_2">- ¥'+Math.abs(diff_adult_price_sum)+'</span></p>';}}
if(diff_children_price_sum!=0){if(diff_children_price_sum>0){summary_html+='<p class="pn"><span class="pn_1">'+person_num.children_num+'儿童 × ¥'+diff_child_price+'</span><span class="pn_2">¥'+diff_children_price_sum+'</span></p>';}else{summary_html+='<p class="pn"><span class="pn_1">'+person_num.children_num+'儿童 × - ¥'+Math.abs(diff_child_price)+'</span><span class="pn_2">- ¥'+Math.abs(diff_children_price_sum)+'</span></p>';}}
summary_html+='</div>';$("#ticket_summary").html(summary_html);$("#ticket_summary").show();}else{$("#ticket_summary").hide();}}
$("#budget").val(user_price);$("#children_budget").val(children_price);$("#slt_ticket_id").val(ticket_id);this.changePrice();},sltCustomTicket:function(flightType){var resId='';var flight_price=0;var children_flight_price=0;if(flightType==1){$("#selectBySelf").find('input[type="radio"]').each(function(){if($(this).attr('checked')==true){resId=$(this).attr('resId');flight_price=flight_price+order_perfect.formatInt($("#custom_ticket_price_"+resId).val());children_flight_price=children_flight_price+order_perfect.formatInt($("#custom_children_ticket_price_"+resId).val());}});}
var route_user_price=this.formatInt($("#route_budget").val());var route_children_price=this.formatInt($("#children_route_budget").val());var user_price=route_user_price+flight_price;var children_price=route_children_price+children_flight_price;var diff_adult_price=0;var diff_child_price=0;var person_num=this.userGet();var default_ticket_id=$("#default_ticket_id").val();var ori_budget=this.formatInt($("#default_budget").val());var ori_children_budget=this.formatInt($("#children_default_budget").val());var default_user_price=$("#ticket_price_"+default_ticket_id).length==0?ori_budget:this.formatInt($("#ticket_price_"+default_ticket_id).val());var default_children_price=$("#children_ticket_price_"+default_ticket_id).length==0?ori_children_budget:this.formatInt($("#children_ticket_price_"+default_ticket_id).val());diff_adult_price=user_price-default_user_price;diff_child_price=children_price-default_children_price;diff_adult_price_sum=diff_adult_price*person_num.user_num;diff_children_price_sum=diff_child_price*person_num.children_num;if(diff_adult_price_sum!=0||diff_children_price_sum!=0){var summary_html='<hr /><div class="part"><p class="part_name">实时机票差</p>';if(diff_adult_price_sum!=0){if(diff_adult_price_sum>0){summary_html+='<p class="pn"><span class="pn_1">'+person_num.user_num+'成人 × ¥'+diff_adult_price+'</span><span class="pn_2">¥'+diff_adult_price_sum+'</span></p>';}else{summary_html+='<p class="pn"><span class="pn_1">'+person_num.user_num+'成人 × - ¥'+Math.abs(diff_adult_price)+'</span><span class="pn_2">- ¥'+Math.abs(diff_adult_price_sum)+'</span></p>';}}
if(diff_children_price_sum!=0){if(diff_children_price_sum>0){summary_html+='<p class="pn"><span class="pn_1">'+person_num.children_num+'儿童 × ¥'+diff_child_price+'</span><span class="pn_2">¥'+diff_children_price_sum+'</span></p>';}else{summary_html+='<p class="pn"><span class="pn_1">'+person_num.children_num+'儿童 × - ¥'+Math.abs(diff_child_price)+'</span><span class="pn_2">- ¥'+Math.abs(diff_children_price_sum)+'</span></p>';}}
summary_html+='</div>';$("#ticket_summary").html(summary_html);$("#ticket_summary").show();}else{$("#ticket_summary").hide();}
$("#budget").val(user_price);$("#children_budget").val(children_price);this.changePrice();},sltSpecialTicket:function(flightType){var resId='';var flight_price=0;var children_flight_price=0;if(flightType==2){$("#specialFlight").find('input[type="radio"]').each(function(){if($(this).attr('checked')==true){resId=$(this).attr('resId');flight_price=flight_price+order_perfect.formatInt($("#special_ticket_price_"+resId).val());children_flight_price=children_flight_price+order_perfect.formatInt($("#special_children_ticket_price_"+resId).val());}});}
var route_user_price=this.formatInt($("#route_budget").val());var route_children_price=this.formatInt($("#children_route_budget").val());var user_price=route_user_price+flight_price;var children_price=route_children_price+children_flight_price;var diff_adult_price=0;var diff_child_price=0;var person_num=this.userGet();var default_ticket_id=$("#default_ticket_id").val();var ori_budget=this.formatInt($("#default_budget").val());var ori_children_budget=this.formatInt($("#children_default_budget").val());var default_user_price=$("#ticket_price_"+default_ticket_id).length==0?ori_budget:this.formatInt($("#ticket_price_"+default_ticket_id).val());var default_children_price=$("#children_ticket_price_"+default_ticket_id).length==0?ori_children_budget:this.formatInt($("#children_ticket_price_"+default_ticket_id).val());diff_adult_price=user_price-default_user_price;diff_child_price=children_price-default_children_price;diff_adult_price_sum=diff_adult_price*person_num.user_num;diff_children_price_sum=diff_child_price*person_num.children_num;if(diff_adult_price_sum!=0||diff_children_price_sum!=0){var summary_html='<hr /><div class="part"><p class="part_name">机票升级费</p>';if(diff_adult_price_sum!=0){if(diff_adult_price_sum>0){summary_html+='<p class="pn"><span class="pn_1">'+person_num.user_num+'成人 × ¥'+diff_adult_price+'</span><span class="pn_2">¥'+diff_adult_price_sum+'</span></p>';}else{summary_html+='<p class="pn"><span class="pn_1">'+person_num.user_num+'成人 × - ¥'+Math.abs(diff_adult_price)+'</span><span class="pn_2">- ¥'+Math.abs(diff_adult_price_sum)+'</span></p>';}}
if(diff_children_price_sum!=0){if(diff_children_price_sum>0){summary_html+='<p class="pn"><span class="pn_1">'+person_num.children_num+'儿童 × ¥'+diff_child_price+'</span><span class="pn_2">¥'+diff_children_price_sum+'</span></p>';}else{summary_html+='<p class="pn"><span class="pn_1">'+person_num.children_num+'儿童 × - ¥'+Math.abs(diff_child_price)+'</span><span class="pn_2">- ¥'+Math.abs(diff_children_price_sum)+'</span></p>';}}
summary_html+='</div>';$("#ticket_summary").html(summary_html);$("#ticket_summary").show();}else{$("#ticket_summary").hide();}
$("#budget").val(user_price);$("#children_budget").val(children_price);this.changePrice();},setDisabled:function(e,coupon){var e_jq=$(e);if(!e_jq.attr('class2')){var eclass=e_jq.attr("class");e_jq.attr('class2',eclass);}
if(e.nodeName=="INPUT"){e_jq.attr("disabled","disabled");}
e_jq.attr("class","cgrey");$("#spanCoupon"+coupon).attr('style','display:none');},setNotDisabled:function(e,coupon){var e_jq=$(e);if(e.nodeName=="INPUT"){e_jq.attr("disabled","");}
e_jq.attr("class",e_jq.attr('class2'));$("#spanCoupon"+coupon).show();},toggleCouponClass:function(e,coupon,isDisabled){if(isDisabled){this.setDisabled(e,coupon)}else{this.setNotDisabled(e,coupon);}},couponShowChange:function(ex_coupon,couponId){var ex=(ex_coupon&couponId)==couponId;if(ex_coupon==0){$("#trCoupon"+couponId).show();}else{$("#trCoupon"+couponId).hide();}
$("#trCoupon"+couponId).children().each(function(i,e){order_perfect.toggleCouponClass(e,couponId,ex);$(e).children().each(function(i,e){order_perfect.toggleCouponClass(e,couponId,ex);});});},setPromoAmount:function(){var total_amount=0;var event_ids='';var summary_html='<hr /><div class="part"><p class="part_name">活动优惠</p>';$("#promotion_part").find('input[type="radio"]').not('#travel_coupon_check').each(function(){if($(this).attr('checked')==true){var event_id=$(this).attr('event_ids');var amount=order_perfect.formatInt($(this).attr('amount'));var per=order_perfect.formatInt($(this).attr('per'));if(per>0){var base_price=order_perfect.formatInt($("#base_price").val());amount=Math.floor(base_price*per/100.0+0.5);}
total_amount+=amount;event_ids+=event_id+';';}});summary_html+='<p class="pn"><span class="pn_1">&nbsp;</span><span class="pn_2">- ¥'+total_amount+'</span></p></div>';if(total_amount>0){$("#promotion_summary").html(summary_html);$("#promotion_summary").show();}else{$("#promotion_summary").hide();}
$("#hidPromoEventIds").val(event_ids);$("#hidPromoAmount").val(total_amount);},selectPromotion:function(type,obj,flag){var ex_coupon=0;$("#"+type+"_promotion").attr('checked',true);$("#"+type+"_promotion").removeAttr('disabled');if(flag==1){var spanPromotion_jq=$('input[name="online_type"]');spanPromotion_jq.attr('checked',true);}else{var spanPromotion_jq=$(obj);}
if(type!=''){ex_coupon=parseInt(spanPromotion_jq.attr('ex_coupon'));}
var need_user=spanPromotion_jq.attr('need_user');if(need_user==1){$(".login").hide();spanPromotion_jq.parent().parent().nextAll('.login').eq(0).show()}
if(type=='other'){$('#use_price').removeAttr('readonly');$('#use_button').removeAttr('disabled');order_perfect.changeTravelCouponUse();}else{$("#hidPromoExCoupon").val(ex_coupon);if(type=='subtract'){if(typeof($('#early_many_promotion'))!="undefined"&&$('#early_many_promotion').attr('checked')==true){$('#early_many_promotion').attr('checked',false);order_perfect.changePromotion('early_many_promotion');}
$('input[name="card_type"]').attr('disabled',true);$('input[name="online_type"]').attr('disabled',true);$('input[name="early_many_type"]').attr('disabled',true);$('input[name="price_subtract_type"]').attr('disabled',true);if(typeof($('#card_promotion'))!="undefined"&&$('#card_promotion').attr('checked')==true){$('#card_promotion').attr('checked',false);order_perfect.changePromotion('card_promotion');$('#card_promotion').parent().parent().find('.order_table').find('input[type="radio"]').removeAttr('checked');$('#card_promotion').parent().parent().find('.order_table').find('.login').hide();}
if(typeof($('#price_subtract_promotion'))!="undefined"&&$('#price_subtract_promotion').attr('checked')==true){$('#price_subtract_promotion').attr('checked',false);order_perfect.changePromotion('price_subtract_promotion');}}else if(type=='price_subtract'){$('input[name="card_type"]').attr('disabled',true);$('input[name="early_many_type"]').attr('disabled',true);$('input[name="subtract_type"]').attr('disabled',true);if(typeof($('#early_many_promotion'))!="undefined"&&$('#early_many_promotion').attr('checked')==true){$('#early_many_promotion').attr('checked',false);order_perfect.changePromotion('early_many_promotion');}
if(typeof($('#card_promotion'))!="undefined"&&$('#card_promotion').attr('checked')==true){$('#card_promotion').attr('checked',false);order_perfect.changePromotion('card_promotion');}
if(typeof($('#subtract_promotion'))!="undefined"&&$('#subtract_promotion').attr('checked')==true){$('#subtract_promotion').attr('checked',false);order_perfect.changePromotion('subtract_promotion');}}
this.couponShowChange(ex_coupon,1);}
this.changePrice();return ex_coupon;},changePromotion:function(obj_id){var obj="#"+obj_id;if($(obj).attr('checked')==false){$(obj).parent().parent().find('.order_table').find('input[type="radio"]').removeAttr('checked');$(obj).parent().parent().find('.order_table').find('.login').hide();$(obj).attr('disabled',true);if(obj_id=='other_promotion'){$('#use_price').attr('readonly',true);$('#use_button').attr('disabled',true);$('#travel_coupon_cut').val(0);$('#use_price_begin').val(0);$('#travel_coupon_summary').hide();}else{this.couponShowChange(0,1);$("#hidPromoExCoupon").val(0);if(obj_id=='subtract_promotion'){$('.upperm').find('input[type="radio"]').removeAttr('disabled');$('input[name="disable_radio"]').attr('disabled',true);}}
this.changePrice();}},login:function(obj){$(obj).parent().find('.err_notice').html('');var name=$(obj).siblings('input[type=text]').val();var pwd=$(obj).siblings('input[type=password]').val();if(name==''){$(obj).parent().find('.err_notice').html('请填写用户名');return false;}
if(pwd==''){$(obj).parent().find('.err_notice').html('请填写密码');return false;}
var url="/main.php?do=online_book_quick_login";$.post(url,{'username':name,'password':pwd},function(data){if(data==1){url='/main.php?do=online_book_promotion_new';var p={'route_id':$("#route_id").val(),'total_price':$("#total_price").val(),'begin_date':$("#begin_date").val(),'user_num':$("#user_num").val(),'children_num':$("#children_num").val(),'slt_ticket_id':$("#slt_ticket_id").val(),'base_price':$("#base_price").val()}
$.post(url,p,function(data){$("#promotion_part").html(data);$("#already_login").val(1);if($("#old_login_t").length>0){$("#old_login_t").hide();}
var flag=$("#has_online_promotion").val();if(flag==1){order_perfect.selectPromotion('online','',1);}
order_perfect.selectPromotion('');order_perfect.changePrice();Contract();});}else{$(obj).parent().find('.err_notice').html('您输入的账号或密码不正确');return false;}});},login_new:function(obj){$(obj).parent().find('.err_notice').html('');var name=$(obj).siblings('input[type=text]').val();var pwd=$(obj).siblings('input[type=password]').val();if(name==''){$(obj).parent().find('.err_notice').html('请填写用户名');return false;}
if(pwd==''){$(obj).parent().find('.err_notice').html('请填写密码');return false;}
var url='/main.php?do=online_book_quick_login&username='+name+"&password="+pwd;$.get(url,function(data){if(data==1){url='/main.php?do=online_book_promotion';var p={'route_id':$("#route_id").val(),'total_price':$("#total_price").val(),'begin_date':$("#begin_date").val(),'user_num':$("#user_num").val(),'children_num':$("#children_num").val(),'slt_ticket_id':$("#slt_ticket_id").val(),'base_price':$("#base_price").val()}
$.post(url,p,function(data){$("#promotion_part").html(data);var flag=$("#has_online_promotion").val();if(flag==1){order_perfect.selectPromotion('online','',1);}
order_perfect.selectPromotion('');order_perfect.changePrice();});$("#already_login").attr("value",1);var url="/main.php?do=online_book&type="+$("#route_type").attr("value");$("#frm_submit").attr("action",url);$("#frm_submit").submit();}else{$(obj).parent().find('.err_notice').html('您输入的账号或密码不正确');return false;}});},getPromotion:function(){url='/main.php?do=online_book_promotion';var p={'route_id':$("#route_id").val(),'total_price':$("#total_price").val(),'begin_date':$("#begin_date").val(),'user_num':$("#user_num").val(),'children_num':$("#children_num").val(),'slt_ticket_id':$("#slt_ticket_id").val(),'base_price':$("#base_price").val()}
$.post(url,p,function(data){$("#promotion_part").html(data);var flag=$("#has_online_promotion").val();if(flag==1){order_perfect.selectPromotion('online','',1);}
order_perfect.selectPromotion('');firstUseTravelCoupon(1);order_perfect.changePrice();});},useTravelCoupon:function(){if($("#travel_coupon_check").attr('checked')==true){$("#travel_coupon_login").show();}else{$("#travel_coupon_login").hide();}},checkPromotion:function(){var need_user='';var is_login=$("#is_login").length;var flag=true;$("#promotion_part").find('input[type="radio"]').not('#travel_coupon_check').each(function(){if($(this).attr('checked')==true){var special_flag=$(this).attr('special_flag');if(special_flag==1){var confirm_count=$(this).attr('confirm_count');if(confirm_count==0){$('#msg_show_'+special_flag).show();flag=false;return false;}}
need_user=$(this).attr('need_user');if(need_user==1&&is_login==0){$(this).parent().parent().nextAll('.login').eq(0).show();$(this).parent().parent().nextAll('.login').eq(0).find('input[type="text"]').focus();flag=false;return false;}}});return flag;},changeTravelCouponUse:function(){var use_price=get_use_price();if(use_price<0){$("#travel_coupon_summary").hide();return false;}else if(use_price>0){$("#travel_coupon_cut_show").html('- ¥'+use_price);$("#travel_coupon_summary").show();}else{$("#travel_coupon_summary").hide();}
chagePriceByTravelCoupon(use_price);order_perfect.changePrice();},change_pick_up:function(){if(document.getElementsByName('need_pick_up')[0].checked==true){$('.pick_up_info').show();$('.pick_up_con').hide();}else{$('.pick_up_info').hide();$('.pick_up_con').show();}},no_pick_up:function(){if(document.getElementsByName('need_pick_up')[1].checked==true){$('.pick_up_info').hide();$('.pick_up_con').show();}else{$('.pick_up_info').show();$('.pick_up_con').hide();}},change_meet_condition:function(){if(document.getElementsByName('meet_condition')[1].checked==true){$('.pick_up_info').show();$('.meet_condition_con').show();$('.no_meet_condition_con').hide();}else{$('.pick_up_info').hide();$('.meet_condition_con').hide();$('.no_meet_condition_con').show();}},no_meet_condition:function(){if(document.getElementsByName('meet_condition')[0].checked==true){$('.pick_up_info').hide();$('.meet_condition_con').hide();$('.no_meet_condition_con').show();}else{$('.pick_up_info').show();$('.meet_condition_con').show();$('.no_meet_condition_con').hide();}},check_arrive_time:function(){if($("#arrive_time:visible").length>0){var arrive_time=$("#arrive_time").val();if(arrive_time==''){$("#arrive_flight_notice").show();var arrive_time_title=$('.arrive_time_title').text();arrive_time_title=$.trim(arrive_time_title);arrive_time_title=arrive_time_title.substring(0,arrive_time_title.length-1);$("#arrive_flight_notice span i").html('请填写'+arrive_time_title);return false;}
$("#arrive_flight_notice").hide();$("#arrive_flight_notice span i").html('');return true;}},check_leave_time:function(){if($("#leave_time:visible").length>0){var leave_time=$("#leave_time").val();if(leave_time==''){$("#leave_flight_notice").show();var leave_time_title=$('.leave_time_title').text();leave_time_title=$.trim(leave_time_title);leave_time_title=leave_time_title.substring(0,leave_time_title.length-1);$("#leave_flight_notice span i").html('请填写'+leave_time_title);return false;}
$("#leave_flight_notice").hide();$("#leave_flight_notice span i").html('');return true;}},check_arrive_flight:function(){if($("#arrive_flight:visible").length>0){var arrive_flight=$("#arrive_flight").val();arrive_flight=arrive_flight.replace(/(^\s*)/g,"");if(arrive_flight==''){$("#arrive_flight_notice").show();var arrive_flight_title=$('.arrive_flight_title').text();arrive_flight_title=$.trim(arrive_flight_title);arrive_flight_title=arrive_flight_title.substring(0,arrive_flight_title.length-1);$("#arrive_flight_notice span i").html('请填写'+arrive_flight_title);return false;}
$("#arrive_flight_notice").hide();$("#arrive_flight_notice span i").html('');return true;}},check_leave_flight:function(){if($("#leave_flight:visible").length>0){var leave_flight=$("#leave_flight").val();leave_flight=leave_flight.replace(/(^\s*)/g,"");if(leave_flight==''){$("#leave_flight_notice").show();var leave_flight_title=$('.leave_flight_title').text();leave_flight_title=$.trim(leave_flight_title);leave_flight_title=leave_flight_title.substring(0,leave_flight_title.length-1);$("#leave_flight_notice span i").html('请填写'+leave_flight_title);return false;}
$("#leave_flight_notice").hide();$("#leave_flight_notice span i").html('');return true;}},check_invoice_title:function(){var title=$("#invoice_title").val();title=title.replace(/(^\s*)/g,"");if(title==''||title=='个人'||title=='客人'||title=='客户'||title=='单位'||title=='公司'||title=='顾客'||title=='部队'||title=='医院'||title=='政府'){$("#invoice_title_notice").show();$("#invoice_title_notice span i").html('请填写正确的个人姓名或公司全称');location.hash='#invoice_title_notice';return false;}
$("#invoice_title_notice").hide();$("#invoice_title_notice span i").html('');return true;},check_invoice_people:function(){var name=$("#invoice_name").val();var result=$.TN_checkName(name);switch(result){case 1:$("#invoice_people_notice").hide();$("#invoice_people_notice span i").html('');return true;break;case 2:$("#invoice_people_notice").show();$("#invoice_people_notice span i").html('请填写收件人');return false;break;case 3:$("#invoice_people_notice").show();$("#invoice_people_notice span i").html('收件人长度请在4-20字符内（1个汉字等于2个字符）');return false;break;default:$("#invoice_people_notice").show();$("#invoice_people_notice span i").html('收件人只能包含中文、英文和空格');return false;break;}},check_invoice_code:function(){var code=$("#invoice_code").val();var reg=/^[0-9]{6}$/;if(!reg.test(code)){$("#invoice_code_notice").show();$("#invoice_code_notice span i").html('请填写正确的邮政编码');return false;}
$("#invoice_code_notice").hide();$("#invoice_code_notice span i").html('');return true;},check_invoice_address:function(){var address=$("#invoice_address").val();address=address.replace(/(^\s*)/g,"");if(address==''){$("#invoice_address_notice").show();$("#invoice_address_notice span i").html('请填写邮寄地址');return false;}
$("#invoice_address_notice").hide();$("#invoice_address_notice span i").html('');return true;},check_invoice_tel:function(){var tel=$("#invoice_tel").val();var result=$.TN_checkTel(tel);switch(result){case 1:$("#invoice_tel_notice").hide();$("#invoice_tel_notice span i").html('');return true;break;default:$("#invoice_tel_notice").show();$("#invoice_tel_notice i").html('请填写正确的手机号码');return false;break;}},check_invoice_phone:function(){var phone=$("#invoice_phone2").val()=='电话号码'?'':$("#invoice_phone2").val();var area_code=$("#invoice_phone1").val()=='区号'?'':$("#invoice_phone1").val();var result=$.TN_checkPhone(area_code,phone);switch(result){case 1:$("#invoice_phone_notice").hide();$("#invoice_phone_notice span i").html("");return true;break;case 2:$("#invoice_phone_notice").show();$("#invoice_phone_notice span i").html('请填写正确的区号');return false;break;default:$("#invoice_phone_notice").show();$("#invoice_phone_notice span i").html('请填写正确的座机号');return false;break;}},check_notice:function(){var flag=$("#agree_check").attr('checked');if(flag){$("#commonTip").css('display','none');return true;}else{var obj=document.getElementById("agree_check");$("#commonTip").css('display','block');return false;}},check_tourist_info:function(){var check=true;if(!this.check_tourist_name()){check=false;}
if(!this.check_tourist_tel()){check=false;}
var phone=$("#tourist_phone2").val();var area_code=$("#tourist_phone1").val();if(phone||area_code){if(!this.check_tourist_phone()){check=false;}}
if(!this.check_tourist_email()){check=false;}
return check;},select_visa_num:function(){var visa_length=$('input[id^="visa_name"]').length;for(i=1;i<=visa_length;i++){var tem_visa_cost=0;tem_visa_cost=$('#visa_price_'+i).val()*$('#share_'+i).val();$('#visa_cost_'+i).html('¥'+tem_visa_cost);}
this.set_visa_summary();},chooseVisa:function(){this.set_visa_summary();},set_visa_summary:function(){if($('input[id^="visa_checkbox"]:checked').length){var visa_summary_html='<p class="part_name">签证费用</p>';var visa_length=$('input[id^="visa_name"]').length;for(i=1;i<=visa_length;i++){if($('input[id="visa_checkbox_'+i+'"]:checked').length){temp_html='';temp_html='<p>'+$('input[id="visa_name_'+i+'"]').val()+'</p>'+'<p class="pn"><span class="pn_1">'+$('#share_'+i).val()+'份 × ¥'+$('#visa_price_'+i).val()+'</span><span class="pn_2">¥'+$('#visa_price_'+i).val()*$('#share_'+i).val()+'</span></p>';visa_summary_html+=temp_html;}}
$('#visa_summary .part').html(visa_summary_html);$('#visa_summary').show();}else{$('#visa_summary .part').html('');$('#visa_summary').hide();}
this.changePrice();}}
$(function(){var ticket_id=$("#slt_ticket_id").val();var all_ticket_id=$("#all_ticket_id").val();if(ticket_id&&all_ticket_id){order_perfect.sltTicket(ticket_id);}
$("#subtract_promotion").removeAttr('checked');order_perfect.changePromotion('subtract_promotion');$("#price_subtract_promotion").removeAttr('checked');order_perfect.changePromotion('price_subtract_promotion');$("#online_promotion").removeAttr('checked');order_perfect.changePromotion('online_promotion');$("#early_many_promotion").removeAttr('checked');order_perfect.changePromotion('early_many_promotion');$("#card_promotion").removeAttr('checked');order_perfect.changePromotion('card_promotion');$("#other_promotion").removeAttr('checked');order_perfect.changePromotion('other_promotion');var flag=$("#has_online_promotion").val();if(flag==1){order_perfect.selectPromotion('online','',1);}
$('#use_price').val(0);});;function getPromotionValue(){var promotionContain=$('#cashbackInfo .discount-coupon .coupon-list .box-selected');var result=0;var ipromotion=0;var iprompt=0;if(promotionContain.length){promotionContain.each(function(){var tmp=parseInt($(this).data('price'));result+=tmp;if(parseInt($(this).data('type'))===14){iprompt+=tmp;}
if(parseInt($(this).data('type'))===21){ipromotion+=tmp;}});}
return{result:result,ipromotion:ipromotion,iprompt:iprompt};};function isPromotionConflict(element){if(element.attr('checked')){var promotionId=element.attr('id');var shares=element.attr('data-shares').split(",");$('.promotionContain').find('input:checked').each(function(index,ele){if($(ele).attr('id')!=promotionId){if(!inArray(promotionId,$(ele).data('shares').split(","))||!inArray($(ele).attr('id'),shares)){$(element).attr("checked",false);layer.alert('与“'+$(ele).attr('data-name')+'”不能同时使用！');return false;}}});}};function inArray(element,arr){for(var i=0;i<arr.length;i++){if(element==arr[i]){return true;}}
return false;};function showdypop(){var url='/main.php?do=order_fill_check_coupon';$.post(url,{'flag':'send_msg','send_time':'first'},function(data){if(data==-1){layer.alert('请先登录。');return false;}else if(data==99){renderPrice(true);}else{var data=eval("("+data+")");var tel=data.tel;var time=data.times;if(time>=5){alert('您今天验证次数已超过5次，为了您的账号安全，请于明天再试。如有需要，请致电4007-999-999与我们联系。');$('.verification_mes_box').hide();return false;}else{if(!tel){var msg='请至会员中心<a href="/main.php?do=user_info_confirm" target="_blank">个人资料</a>处绑定手机';$('#user_phone').html(msg);showpopup($('.verification_mes_box'),$('.verification_mes_box .c_close'));$("#send_again_60_second").hide();$("#send_link").show();return false;}
var telHead=tel.substr(0,3);var targetTel='133,153,180,189';if(targetTel.indexOf(telHead)>-1){$('#dx_error_msg_tel').hide().html('尊敬的用户，电信短信服务升级中，如您未能收到短信验证码，请致电4007-999-999。');}else{$('#dx_error_msg_tel').hide().html('');}
$('#user_phone').html(tel);showpopup($('.verification_mes_box'),$('.verification_mes_box .c_close'));try{var arrPageSizes=___getPageSize();$('.verification_mes_box').css({top:parseInt($('.verification_mes_box').css("top"))-(arrPageSizes[3]/5)+(arrPageSizes[3]-parseInt($('#noDate').css("height")))/2-10});}catch(e){}}}})}
var times=60;var isinerval;$("#send_link").hide();$(function(){$("#send_again_60_second").attr("disabled",true);isinerval=setInterval("CountDown()",1000);});function CountDown(){if(times<1){$("#send_again_60_second").hide();$("#send_link").show();clearInterval(isinerval);$('#dx_error_msg_tel').show();return;}
$("#send_again_60_second").val(times+"秒后重新发送");times--;}
function send_again(){var times=60;var isinerval;$("#send_link").hide();$("#send_again_60_second").show();$("#send_again_60_second").val(times+"秒后重新发送");$("#send_again_60_second").attr("disabled",true);var url='/main.php?do=order_fill_check_coupon';$.post(url,{'flag':'send_msg','send_time':'again'},function(data){if(data==1){layer.alert('请先登录。');}else{data=eval("("+data+")");var tel=data.tel;var time=data.times;if(time>=5){alert('您今天验证次数已超过5次，为了您的账号安全，请于明天再试。如有需要，请致电4007-999-999与我们联系。');$('.verification_mes_box').hide();return false;}else{$('#user_phone').html(tel);}}})
isinerval=setInterval(function(){if(times<1){$("#send_again_60_second").hide();$("#send_link").show();clearInterval(isinerval);$('#dx_error_msg_tel').show();return;}
$("#send_again_60_second").val(times+"秒后重新发送");times--;},1000);}
function check_mark(){var mark=$('#mark_area').val();if(!mark){$('#error_msg').html('验证码不能为空');return false;}else{var url='/main.php?do=order_fill_check_coupon';$.post(url,{'flag':'check_mark','mark':mark},function(data){if(data==-1){layer.alert('请先登录。');}else if(data==-2){$('#error_msg').html('验证码已失效，请重新发送。');return false;}else if(data==-3){$('#error_msg').html('验证码错误，请重新输入。');$('#mark_area').val('');return false;}else if(data==1){$('.verification_mes_box').hide();$('#divmask').remove();renderPrice(true);window.verificationCode=true;return true;}})}}
function formatInt(num){num=parseInt(num);num=isNaN(num)?0:num;return num;}
function checkTravelCoupons(){window.isSuitable=false;var iTravelCouponsTotal=$('#travel_left_coupon').val();var iTravelCouponsUser=$('#use_price').val();var ired=0;var $error=$('#travelCoupons_error');var $msg=$error.find('.msg');var isNum=iTravelCouponsUser?/^[\d.]+$/g.test(iTravelCouponsUser):true;if(!isNum){$msg.text('请输入正数。');$error.show();isSuitable=false;$('#g_next')[0].disabled=true;}else if(isNum&&iTravelCouponsUser-0<0)
{$msg.text('请输入有效数值。');$error.show();isSuitable=false;$('#g_next')[0].disabled=true;}else{var mostcanuse=mostTravelCouponNum();if(mostcanuse<=0){$('#use_price').val(0);$error.hide();isSuitable=false;$('#g_next')[0].disabled=false;}else if(iTravelCouponsUser>mostcanuse){$('#use_price').val(mostcanuse);$error.hide();isSuitable=true;$('#g_next')[0].disabled=false;}else{$error.hide();isSuitable=true;$('#g_next')[0].disabled=false;if(window.verificationCode){if($('#businessType').val()==='3'){var promotion=getPromotionValue();var tip='<div class="big-up-arrow"></div><div class="small-up-arrow"></div>';if(promotion.ipromotion)tip+='<span>优惠券已减￥'+promotion.ipromotion+'</span><br>';if(promotion.iprompt)tip+='<span>立减活动已减￥'+promotion.iprompt+'</span><br>';if(ired)tip+='<span>酒店红包￥'+ired+'元</span><br>';if(iTravelCouponsUser)tip+='<span>旅游券已减￥'+iTravelCouponsUser+'元</span><br>';if(iTravelCouponsUser+ired+promotion.ipromotion+promotion.iprompt){$('.promotionTip .promotionTotal span').text(iTravelCouponsUser+ired+promotion.ipromotion+promotion.iprompt);$('.promotionTip .tip').html(tip);$('.promotionTip').css({display:'inline-block'});}else{$('.promotionTip').hide();}
var totalPrice=parseFloat($('#totalPrice').val());var realPrice=totalPrice-iTravelCouponsUser-ired-promotion.result;$('#realPrice,.totalPrice').add($('.invoice_price')).html(parseFloat(realPrice).toFixed(2));$('.travelCoupons_cut').text('￥'+iTravelCouponsUser);}else{$('#cashBack').add($('#cashBackTips')).text(iTravelCouponsUser);$('#cashBacked').val(iTravelCouponsUser);}}}}}
$(document).delegate('#use_price','blur',function(){checkTravelCoupons();if(window.isSuitable){showdypop();}});function mostTravelCouponNum(){var iTravel=$('#travel_left_coupon').val()-0;var totalPrice=parseFloat($('#totalPrice').val());if($('#businessType').val()==='3'){var iPromotion=getPromotionValue().result;var ired=0;if(iPromotion+iTravel+ired>totalPrice){var iMid=iPromotion+iTravel+ired-totalPrice;if(iTravel>iMid){iTravel=iTravel-iMid;}else{iTravel=0;}}}else{var iPromotion=getPromotionValue().result,ired=0;var iOringal=$('.cashBackTotal').text().match(/\d+/)-0;if(iPromotion+iTravel+iOringal+ired>totalPrice){var iMid=iPromotion+iTravel+iOringal+ired-totalPrice;if(iTravel>iMid){iTravel=iTravel-iMid;}else{iTravel=0;}}}
return iTravel;}
function fixTravelCouponNum(){var applyCoupons=$(".apply_coupon");var applyedCoupons=$(".applyed_coupon");applyedCoupons.hide();applyCoupons.show();$('#g_next').attr('disabled',true).addClass("btn_disabled");}
function changePriceByTravelCoupon(use_price){hotel_order.changePrice();};;(function(){var ChatEntry={};var available={'product':[6],'order':[],'channel':[6],};ChatEntry.checkEntry=function(entranceType,entranceId){return available[entranceType].indexOf(entranceId)>-1;};ChatEntry.openChat=function(entranceType,entranceId,entryParam){if(!this.checkEntry(entranceType,entranceId)){return;}
if(typeof _gaq!='undefined'){_gaq.push(['_trackEvent','在线客服按钮_1','','']);}
entryParam=entryParam||{};var paramStr=Object.keys(entryParam).reduce(function(pre,cur,index,array){var res=pre+(entryParam[cur]?((index>0?'&':'')+cur+'='+entryParam[cur]):'');return res;},'');;var livechatUrl=encodeURI('http://dynamic.m.tuniu.com/livechat?'+paramStr);window.open(livechatUrl,'在线客服','width=640, height=515, top=100, left=500, toolbar=no, menubar=no, scrollbars=no, resizable=no, location=no, status=no');};if(typeof module!=='undefined'&&typeof exports==='object'){module.exports=ChatEntry;}else if(typeof define==='function'&&(define.amd||define.cmd)){define(function(){return ChatEntry;});}else{this.ChatEntry=ChatEntry;}}).call(this||(typeof window!=='undefined'?window:global));;var tourPage={__commScroll:function(){if($("#right_scroll").length==0){var rightHtml='<div id="right_scroll" class="right_scroll"><ul></ul></div>';$(document.body).append(rightHtml);$("#right_scroll").css({right:0,bottom:120});}},__scrollPosition:function(obj){var st=$(window).scrollTop(),winh=$(window).height(),t=$(document).scrollTop();if(t>winh){$('.toTop').removeClass("hide");}
else{$('.toTop').addClass("hide");}
if(!window.XMLHttpRequest){obj.css({"top":st+winh-winh/2,"background-attachment":"fixed","background-image":"url(about:blank)"});}},__addWeChat:function(){var $weChat=$('<li class="des"><p>扫码即领<br>150元<br>现金券</p></li><li class="erweima"><img src="http://img4.tuniucdn.com/hotel-newRightScroll/erweima.jpg?v=1"></li><li class="des-code">途牛酒店特卖</li>');addAttr($weChat);function addAttr(obj,fnshow){fnshow=obj.appendTo($("#right_scroll ul"));}},__onLineService:function(){var service=$('<li class="com-li kefu-li"><a class="onlineService" title="在线客服"><div class="kefu"></div><p class="kefu-des">在线客服</p></a></li>');addAttr(service);function addAttr(obj,fnshow){fnshow=obj.appendTo($("#right_scroll ul"));}},__addAdvise:function(){var $advise=$('<li class="com-li fankui-li"><a title="用户反馈" href="/services/advise" target="_blank"><div class="fankui"></div><p class="fankui-des">用户反馈</p></a></li>');addAttr($advise);function addAttr(obj,fnshow){fnshow=obj.appendTo($("#right_scroll ul"));}},__addHelpCenter:function(){var $help=$('<li class="com-li ques-li"><a title="帮助中心" href="http://www.tuniu.com/help/hotel_index.shtml" target="_blank"><div class="ques"></div><p class="ques-des">帮助中心</p></a></li>');addAttr($help);function addAttr(obj,fnshow){fnshow=obj.appendTo($("#right_scroll ul"));}},__backTop:function(){var backTop=$('<li class="toTop hide"><a><img src="http://img4.tuniucdn.com/hotel-newRightScroll/top.png" alt=""></a></li>');addAttr(backTop);function addAttr(obj,fnshow){fnshow=obj.appendTo($("#right_scroll ul"));}
backTop.click(function(){$("html,body").animate({scrollTop:0},"slow");});},};$(function(){tourPage.__commScroll();tourPage.__addWeChat();tourPage.__addAdvise();tourPage.__addHelpCenter();tourPage.__backTop();$(window).bind("scroll",function(){setTimeout(function(){tourPage.__scrollPosition($("#right_scroll"))
tourPage.__scrollPosition($("#right_scroll"))},500);});});